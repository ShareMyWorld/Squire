!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function r(e){return e.nodeType===ee&&!!Te[e.nodeName]}function i(e){return be.test(e.nodeName)}function a(e){var t=e.nodeType;return t===ee?u(e):t===oe&&(!i(e)&&o(e.childNodes,i))}function s(e){var t=e.nodeType;return!(t!==ee&&t!==oe||i(e)||a(e))}function l(e){return e&&"BLOCKQUOTE.blockquote"===P(e)}function d(e){return e&&"BLOCKQUOTE.aside"===P(e)}function c(e){return e&&/^[OU]L$/.test(e.nodeName)}function f(e){return e&&"LI"===e.nodeName}function u(e){var t=P(e);return e&&"P"===t||"P.paragraph"===t}function h(e){return e&&/^H\d$/.test(e.nodeName)}function p(e){return e&&"P.page-break-container"===P(e)}function g(e){return e&&"MYWO-CONTENT-WIDGET"===e.nodeName}function m(e,t){var o=new n(t,re,a);return o.currentNode=e,o}function v(e,t){return e=m(e,t).previousNode(),e!==t?e:null}function C(e,t){return e=m(e,t).nextNode(),e!==t?e:null}function _(e,t){return!r(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function S(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function N(e,t,n,o){for(;e&&e!==t;){if(S(e,n,o))return e;e=e.parentNode}return null}function b(e,t,n){for(;e&&e!==t;){if(n(e))return e;e=e.parentNode}return null}function T(e,t,n){do{if(e.nodeName.match("^"+t)&&(!n||S(e,e.nodeName,n)))return e}while(e=e.parentNode);return null}function k(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function y(e,t){var n,o,r,i,a="";return e&&e!==t&&(a=y(e.parentNode,t),e.nodeType===ee&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(r=o.split(/\s\s*/),r.sort(),a+=".",a+=r.join(".")),(i=e.dir)&&(a+="[dir="+i+"]"))),a}function E(e){return e.nodeType===ee?e.childNodes.length:e.length||0}function B(e){var t=e.parentNode;return t&&t.removeChild(e),e}function x(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function O(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function A(e,n,o,r){var i,a,s,l=e.createElement(n);if(o instanceof Array&&(r=o,o=null),o)for(i in o)o[i]!==t&&l.setAttribute(i,o[i]);if(r)for(a=0,s=r.length;a<s;a+=1)l.appendChild(r[a]);return l}function L(e,t){var n,o,s=e.ownerDocument,l=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=G(s).createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===te)return l;if(e.parentNode&&!e.isContentEditable)return l;if(i(e)){for(o=e.firstChild;me&&o&&o.nodeType===te&&!o.data;)e.removeChild(o),o=e.firstChild;o||(me?(n=s.createTextNode(ie),G(s)._didAddZWS()):n=s.createTextNode(""))}else if(ge){for(;e.nodeType!==te&&!r(e);){if(!(o=e.firstChild)){n=s.createTextNode("");break}e=o}e.nodeType===te?/^ +$/.test(e.data)&&(e.data=""):r(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(a(e)&&e.lastChild&&"BR"!==e.lastChild.nodeName)n=A(s,"BR");else if(!e.querySelector("BR"))for(n=A(s,"BR");(o=e.lastElementChild)&&!i(o);)e=o;if(n)try{e.appendChild(n)}catch(t){G(s).didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return l}function w(e,t,n){var o,r,a;u(e.firstChild)?o=e.firstChild:(o=A(t,n.blockTag,n.blockAttributes),e.insertBefore(o,e.firstChild));for(var r=o.nextSibling;r;)a=r.nextSibling,i(r)?o.appendChild(r):r.nodeType===ee&&(B(r),o.appendChild(O(r))),r=a}function R(e,t,n,o){"LI"===t.nodeName&&(t=t.parentNode),U(e,n._translateToSmw[P(t)],n,!0),L(e,n._root)}function U(e,t,n,o){for(var a,s,l=e.firstChild;l;){if(a=!1,l.nodeType===ee)if(!(s=n._translateToSmw[l.nodeName])||!i(l)||t&&!I(s,t,n))r(l)||e.insertBefore(O(l),l.nextSibling),a=!0;else if(r(l))o&&l===e.firstChild&&"BR"===l.nodeName&&(a=!0);else{for(var d=l.querySelectorAll(l.nodeName),c=0;c<d.length;c++){var f=d[c];f.parentNode.insertBefore(O(f),f),B(f)}U(l,t,n,o&&l===e.firstChild)}else if(l.nodeType===te){var u=l.previousSibling;u&&u.nodeType===te&&(u.data+=l.data,B(l),l=u)}var h=l.nextSibling;a&&B(l),l=h}}function D(e,t,n){if(f(e))return c(t);if(u(e)){var o=F(t,n);return"containers"===o||"blockWithText"===o}var r=n._translateToSmw[P(e)];if(!r)if(p(e))r="hr";else{if(!g(e))return!1;r="smwWidget"}var i=n._translateToSmw[P(t)],a=i||t.nodeName.toLowerCase(),s=n._allowedBlocksForContainers[a];return s&&-1!==s.indexOf(r)}function I(e,t,n){var o=n._allowedInlineContentForBlocks[t];return o&&-1!==o.indexOf(e)}function P(e){var t;return e&&e.nodeType===ee?(t=e.getAttribute("class"))?e.nodeName+"."+t:e.nodeName:""}function W(e,t){if(e.isContentEditable){var n,o,r,a,s,l,d,f=e.childNodes,u=e.ownerDocument,h=G(u),p=h._config,g=F(e,h);for("blockWithText"!==g||c(e)||w(e,u,p),r=0,a=f.length;r<a;r+=1)if(s=f[r],!(l="BR"===s.nodeName)&&i(s))n||(n=A(u,p.blockTag,p.blockAttributes)),n.appendChild(s),r-=1,a-=1;else if(l||n)n||(n=A(u,p.blockTag,p.blockAttributes)),o=c(e)?A(u,"LI",[n]):n,l?e.replaceChild(o,s):(e.insertBefore(o,s),r+=1,a+=1),R(n,e,h,u),n=o=null;else if(d=F(s,h),D(s,e,h))switch("paragraph"!==d&&M(s,h,u,p)&&(r+=1,a+=1),d){case"containers":case"blockWithText":W(s,t);break;case"paragraph":R(s,e,h,u)}else"blockAtomic"===d||s.nodeType!==ee&&s.nodeType!==te||!/\S/.test(s.textContent)?(B(s),r-=1,a-=1):(n=A(u,p.blockTag,p.blockAttributes),o=c(e)?A(u,"LI",[n]):n,e.replaceChild(o,s),n.appendChild(s),R(n,e,h,u),n=o=null);return n&&(o=c(e)?A(u,"LI",[n]):n,e.appendChild(o),R(n,e,h,u)),"containers"===g&&h._ensureBottomLine(e),e}}function M(e,t,n,o){var r=F(e,t),i=!1;if("blockAtomic"===r||"containers"===r||l(e)||c(e))switch(F(e.previousSibling||e.parentNode,t)){case"blockAtomic":case"containers":var a=L(A(n,o.blockTag,o.blockAttributes),t._root);e.parentNode.insertBefore(a,e),i=!0}return i}function F(e,t){var n;if(e===t._root)n=t._inlineMode?"blockWithText":"containers";else if(u(e))n="paragraph";else if(f(e))n="blockWithText";else if(p(e)||g(e))n="blockAtomic";else{var o=P(e),r=t._translateToSmw[o];n=t._allowedContent[r]}return n}function q(e,t,n,o){var r,i,a,s=e.nodeType;if(s===te&&e!==n)return q(e.parentNode,e.splitText(t),n,o);if(s===ee){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(r=e.parentNode,i=e.cloneNode(!1);t;)a=t.nextSibling,i.appendChild(t),t=a;return"OL"===e.nodeName&&N(e,o,"BLOCKQUOTE")&&(i.start=(+e.start||1)+e.childNodes.length-1),L(e,o),L(i,o),(a=e.nextSibling)?r.insertBefore(i,a):r.appendChild(i),q(r,i,n,o)}return t}function H(e,t){if(e.nodeType===ee)for(var n,o,r,a=e.childNodes,s=a.length,l=[];s--;)if(n=a[s],o=s&&a[s-1],s&&i(n)&&_(n,o)&&!Te[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=E(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=E(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=E(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=E(o))),B(n),n.nodeType===te?o.appendData(n.data):l.push(O(n));else if(n.nodeType===ee){for(r=l.length;r--;)n.appendChild(l.pop());H(n,t)}}function K(e,t,n){for(var o,r,i,a=t;1===a.parentNode.childNodes.length;)a=a.parentNode;B(a),e.normalize(),r=e.childNodes.length,o=e.lastChild,o&&"BR"===o.nodeName&&(e.removeChild(o),r-=1),i={startContainer:e,startOffset:r,endContainer:e,endOffset:r},e.appendChild(O(t)),H(e,i),n.setStart(i.startContainer,i.startOffset),n.collapse(!0),ue&&(o=e.lastChild)&&"BR"===o.nodeName&&e.removeChild(o)}function Q(e,t){var n,o,r=e.previousSibling,i=e.firstChild,a=e.ownerDocument,l="LI"===e.nodeName;if((!l||i&&/^[OU]L$/.test(i.nodeName))&&"H"!==e.nodeName[0])if(r&&_(r,e)){if(!s(r)){if(!l)return;o=A(a,"DIV"),o.appendChild(O(r)),r.appendChild(o)}B(e),n=!s(e),r.appendChild(O(e)),n&&W(r,t),i&&Q(i,t)}else l&&(r=A(a,"DIV"),e.insertBefore(r,i),L(r,t))}function G(e){for(var t,n=it.length;n--;)if(t=it[n],t._doc===e)return t;return null}function j(e,t){var n,o;e||(e={});for(n in t)o=t[n],e[n]=o&&o.constructor===Object?j(e[n],o):o;return e}function Z(e,t){e.nodeType===ne&&(e=e.body);var n,o=e.ownerDocument,r=o.defaultView;this._win=r,this._doc=o,this._root=e,this._events={},this._lastSelection=null,ve&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent),this.addEventListener("undoStateChange",this._updateUndoState),this._undoIndex=-1,this._undoStack=[],this._undoScrollTopStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._canUndo=!1,this._canRedo=!1,Ce?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",z),this.addEventListener("input",V),this.addEventListener("mousedown",V),this.addEventListener("touchstart",V),this.addEventListener("focus",$),this._onSelectionChange=X.bind(this),o.addEventListener("selectionchange",this._onSelectionChange,!0),this._awaitingPaste=!1,this.addEventListener(fe?"beforecut":"cut",nt),this.addEventListener("copy",ot),this.addEventListener(fe?"beforepaste":"paste",rt),this.addEventListener(ue?"keypress":"keydown",He),this._keyHandlers=Object.create(Qe),this._blockKeyEvents=!1,this.setConfig(t),this._allowedContent=kt(t.classifications,t.allowedTags),this._classifications=t.classifications,this._allowedBlocks=t.allowedBlocksForContainers,this._allowedBlocksForContainers=t.allowedBlocksForContainers,this._allowedInlineContentForBlocks=t.allowedInlineContentForBlocks,this._translateToSmw=yt(t.tagAttributes,t.allowedTags),this._validTags=Object.keys(this._translateToSmw),this._onPasteErrorCallback=t.onPasteErrorCallback,this._onPasteCallback=t.onPasteCallback,this._inlineMode=t.inlineMode,this.confirmDeleteWidget=t.confirmDeleteWidget,fe&&(r.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,r=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),r&&this.deleteData(e,r),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}it.push(this),this.setHTML(t.html||"",!1,!0)}function z(){this._restoreSelection=!0}function V(){this._restoreSelection=!1}function $(){this._restoreSelection&&this.setSelection(this._lastSelection)}function Y(e,t,n){var o,r;for(o=t.firstChild;o;o=r){if(r=o.nextSibling,i(o)){if(o.nodeType===te||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(a(o)){n.appendChild(e.createDefaultBlock([Y(e,o,e._doc.createDocumentFragment())]));continue}Y(e,o,n)}return n}function X(e){for(var t=this.getSelection(),n=t.commonAncestorContainer;n&&"BODY"!==n.nodeName&&!g(n);)n=n.parentNode;if(g(n))t.selectNode(n),this.setSelection(t);else if(t.startContainer&&t.collapsed&&!i(t.startContainer)&&!a(t.startContainer)){var o,r=t.startContainer.childNodes;o=r.length>0?r[Math.min(r.length-1,t.startOffset)]:t.startContainer;var s=C(o,this._root),l=!0;s||(s=v(o,this._root),l=!1),s&&(l?t.setStart(s,0):t.setStart(s,E(s)),t.collapse(!0),Re(t),console.log("fixing selection",t),this.setSelection(t))}}function J(e,t,o,r){if(t=t.toUpperCase(),o||(o={}),!r&&!(r=this.getSelection()))return[];!r.collapsed&&r.startContainer.nodeType===te&&r.startOffset===r.startContainer.length&&r.startContainer.nextSibling&&r.setStartBefore(r.startContainer.nextSibling),!r.collapsed&&r.endContainer.nodeType===te&&0===r.endOffset&&r.endContainer.previousSibling&&r.setEndAfter(r.endContainer.previousSibling);var i,a,s=r.commonAncestorContainer,l=[],d=N(s,e,t,o);if(d&&l.push(d),s.nodeType===te)return l;for(i=new n(s,re,function(e){return we(r,e,!0)});a=i.nextNode();)S(a,t,o)&&l.push(a);return l}var ee=1,te=3,ne=9,oe=11,re=1,ie="​",ae=e.defaultView,se=navigator.userAgent,le=/iP(?:ad|hone|od)/.test(se),de=/Mac OS X/.test(se),ce=/Gecko\//.test(se),fe=/Trident\/[456]\./.test(se),ue=!!ae.opera,he=/Edge\//.test(se),pe=!he&&/WebKit\//.test(se),ge=fe||ue,me=fe||pe,ve=fe,Ce=!1,_e=/[^ \t\r\n]/,Se=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Ne={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;){if((e=t.nextSibling)&&e.nodeType===ee&&"false"===e.getAttribute("contenteditable"))return this.currentNode=e,e;e||(t=t.parentNode)}if(!e)return null;if(Ne[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){if(t===n)return null;if((e=t.previousSibling)&&e.nodeType===ee&&"false"===e.getAttribute("contenteditable"))return this.currentNode=e,e;if(e)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(Ne[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(Ne[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}};var be=/^(?:#text|A|BR|B|I|STRONG|EM|INPUT)$/,Te={BR:1,IMG:1,INPUT:1},ke=function(e,t){for(var n=e.childNodes;t&&e.nodeType===ee;)e=n[t-1],n=e.childNodes,t=n.length;return e},ye=function(e,t){if(e.nodeType===ee){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Ee=function(e){if(e.collapsed&&e.startContainer.nodeType===te)for(var t,n=e.startContainer.textContent,o=/\S+/g;null!==(t=o.exec(n));){var r=t.index,i=t.index+t[0].length;if(r<e.startOffset&&i>e.startOffset){e.setStart(e.startContainer,r),e.setEnd(e.startContainer,i);break}}return e},Be=function(e,t){var n,o,r,i,a=e.startContainer,s=e.startOffset,l=e.endContainer,d=e.endOffset;a.nodeType===te?(n=a.parentNode,o=n.childNodes,s===a.length?(s=Se.call(o,a)+1,e.collapsed&&(l=n,d=s)):(s&&(i=a.splitText(s),l===a?(d-=s,l=i):l===n&&(d+=1),a=i),s=Se.call(o,a)),a=n):o=a.childNodes,r=o.length,s===r?a.appendChild(t):a.insertBefore(t,o[s]),a===l&&(d+=o.length-r),e.setStart(a,s),e.setEnd(l,d)},xe=function(e,n,o,r){var i=e.startContainer,a=e.startOffset,s=e.endContainer,l=e.endOffset;n||(n=e.commonAncestorContainer),n.nodeType===te&&(n=n.parentNode);var d,c,f,u=r!=t&&new RegExp(r).test(s.nodeName)?s:q(s,l,n,o),h=r!=t&&new RegExp(r).test(i.nodeName)?i:q(i,a,n,o),p=n.ownerDocument.createDocumentFragment();if(h===u&&r!=t&&new RegExp(r).test(h.nodeName))return p.appendChild(h),p;for(;h!==u;)d=h.nextSibling,p.appendChild(h),h=d;return i=n,a=u?Se.call(n.childNodes,u):n.childNodes.length,f=n.childNodes[a],c=f&&f.previousSibling,c&&c.nodeType===te&&f.nodeType===te&&(i=c,a=c.length,c.appendData(f.data),B(f)),e.setStart(i,a),e.collapse(!0),L(n,o),p},Oe=function(e,t){for(var n=e.startContainer,o=e.endContainer;n&&n!==t;)n.nodeType===te||n.isContentEditable||e.setStartBefore(n),n=n.parentNode;for(;o&&o!==t;)o.nodeType===te||o.isContentEditable||e.setEndAfter(o),o=o.parentNode},Ae=function(e,t){Oe(e,t),Ue(e);var n=e.startContainer,o=e.endContainer,r=(i(n)||a(n))&&(i(o)||a(o)),s=xe(e,null,t);Re(e),n=De(e,t),r&&(o=Ie(e,t),n&&o&&n!==o&&K(n,o,e)),n&&L(n,t);var l=t.firstChild;return l&&"BR"!==l.nodeName?e.collapse(!1):(L(t,t),e.selectNodeContents(t.firstChild)),s},Le=function(e,t,n){for(var o=!0,r=t.childNodes,l=r.length;l--;)if(!i(r[l])){o=!1;break}if(e.collapsed||Ae(e,n),Re(e),o)Be(e,t),e.collapse(!1);else{for(var d,c,f,u,h,p=e.startContainer,g=q(p,e.startOffset,N(p.parentNode,n,"BLOCKQUOTE")||n,n),m=g.previousSibling,_=m,S=_.childNodes.length,b=g,T=0,k=g.parentNode;(d=_.lastChild)&&d.nodeType===ee;){if("BR"===d.nodeName){S-=1;break}_=d,S=_.childNodes.length}for(;(d=b.firstChild)&&d.nodeType===ee&&"BR"!==d.nodeName;)b=d;for(h=_.childNodes[S]||null;(d=t.firstChild)&&i(d);)_.insertBefore(d,h);for(;(d=t.lastChild)&&i(d);)b.insertBefore(d,b.firstChild),T+=1;if(c=t,k.insertBefore(t,g),u=m.nextSibling,(c=v(u,n))&&!/\S/.test(c.textContent))do{k=c.parentNode,k.removeChild(c),c=k}while(c&&!c.lastChild&&c!==n);if(m.parentNode||(m=u.previousSibling),_.parentNode||(_=m||u.parentNode,S=m?m.childNodes.length:0),s(u)&&u.isContentEditable&&Q(u,n),f=g.previousSibling,(c=a(g)?g:C(g,n))&&!/\S/.test(c.textContent))do{k=c.parentNode,k.removeChild(c),c=k}while(c&&!c.lastChild&&c!==n);g.parentNode||(g=f.nextSibling),T||(b=f,T=f.childNodes.length),g&&s(g)&&g.isContentEditable&&Q(g,n),e.setStart(_,S),e.setEnd(b,T),Oe(e,n),Re(e)}},we=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var r=e.compareBoundaryPoints(3,o)>-1,i=e.compareBoundaryPoints(1,o)<1;return!r&&!i}var a=e.compareBoundaryPoints(0,o)<1,s=e.compareBoundaryPoints(2,o)>-1;return a&&s},Re=function(e){for(var t,n=e.startContainer,o=e.startOffset,i=e.endContainer,a=e.endOffset;n.nodeType!==te&&(t=n.childNodes[o])&&!r(t)&&t.isContentEditable;)n=t,o=0;if(a)for(;i.nodeType!==te&&(t=i.childNodes[a-1])&&!r(t)&&t.isContentEditable;)i=t,a=E(i);else for(;i.nodeType!==te&&(t=i.firstChild)&&!r(t)&&t.isContentEditable;)i=t;e.collapsed?(e.setStart(i,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(i,a))},Ue=function(e,t){var n,o=e.startContainer,r=e.startOffset,i=e.endContainer,a=e.endOffset;for(t||(t=e.commonAncestorContainer);o!==t&&!r;)n=o.parentNode,r=Se.call(n.childNodes,o),o=n;for(;i!==t&&a===E(i);)n=i.parentNode,a=Se.call(n.childNodes,i)+1,i=n;e.setStart(o,r),e.setEnd(i,a)},De=function(e,t){var n,o=e.startContainer;return i(o)?n=v(o,t):a(o)?n=o:(n=ke(o,e.startOffset),n=C(n,t)),n&&we(e,n,!0)?n:null},Ie=function(e,t){var n,o,r=e.endContainer;if(i(r))n=v(r,t);else if(a(r))n=r;else{if(!(n=ye(r,e.endOffset)))for(n=t;o=n.lastChild;)n=o;n=v(n,t)}return n&&we(e,n,!0)?n:null},Pe=new n(null,4|re,function(e){return e.nodeType===te?_e.test(e.data):"IMG"===e.nodeName}),We=function(e,t){var n=e.startContainer,o=e.startOffset;if(Pe.root=null,n.nodeType===te){if(o)return!1;Pe.currentNode=n}else Pe.currentNode=ye(n,o);return Pe.root=De(e,t),!Pe.previousNode()},Me=function(e,t){var n,o=e.endContainer,r=e.endOffset;if(Pe.root=null,o.nodeType===te){if((n=o.data.length)&&r<n)return!1;Pe.currentNode=o}else Pe.currentNode=ke(o,r);return Pe.root=Ie(e,t),!Pe.nextNode()},Fe=function(e,t){for(var n,o,r,i=e.commonAncestorContainer,a=null;i&&i!==t;)"false"!==i.getAttribute("contenteditable")&&i.isContentEditable||(a=i),i=i.parentNode;a?(n=a,o=a):(n=De(e,t),o=Ie(e,t)),n&&o&&(r=n.parentNode,e.setStart(r,Se.call(r.childNodes,n)),r=o.parentNode,e.setEnd(r,Se.call(r.childNodes,o)+1))},qe={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},He=function(e){var t=e.keyCode,n=qe[t],o="",r=this.getSelection();if(!e.defaultPrevented){if(this._blockKeyEvents)return void e.preventDefault();n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),ue&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-"),e.shiftKey&&(o+="shift-")),n=o+n,-1===this._undoIndex&&this.saveUndoState(r),this._keyHandlers[n]?this._keyHandlers[n](this,e,r):1!==n.length||r.collapsed||(r.commonAncestorContainer&&b(r.commonAncestorContainer,this._root,g)?e.preventDefault():(this.saveUndoState(r),Ae(r,this._root),this._ensureBottomLine(),this.setSelection(r),this._updatePath(r,!0)))}},Ke=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===te&&(o=o.parentNode),n=o;i(n)&&(!n.textContent||n.textContent===ie);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,Se.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),a(n)||(n=v(n,e._root)),L(n,e._root),Re(t)),a(n)&&(n.nodeName!==e._config.blockTag?(W(e._root,e._root),Re(t)):H(n,t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&B(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},Qe={"shift-enter":function(e,t,n){It(e,n)||t.preventDefault()},enter:function(e,t,n){var o=e._root;t.preventDefault(),e._recordUndoState(n),bt(n.startContainer),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||Ae(n,o),W(o,o);var r=De(n,o);if(!r)return n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);var i,a,s,c=r.parentNode;if(c===o||d(c)?(i=c,c=r):i=c.parentNode,e._inlineMode){var u=A(e._doc,"br");Be(n,u),n.setStartAfter(u),n.setEndAfter(u)}else{var p=N(n.startContainer,o,"A");for(h(c)?r.textContent.trim()?0===n.startOffset?(i.insertBefore(e.createDefaultBlock(),c),a=r):a=ut(e,c,n):(i.insertBefore(e.createDefaultBlock(),c),B(c),a=ft(e,r,n.startContainer,n.startOffset)):l(c)?a=ut(e,c,n):f(c)?i.lastElementChild!==c||r.textContent.trim()?(s=ft(e,c,n.startContainer,n.startOffset),a=s.firstElementChild):(e.modifyBlocks(St,n),a=r):a=ft(e,r,n.startContainer,n.startOffset),dt(r),Xe(r),L(r,o);a.nodeType===ee;){var g,m=a.firstChild;if("A"===a.nodeName){var v=a.textContent;if(v===ie&&(v=""),!v||p&&p.textContent&&p.href===a.href){m=e._doc.createTextNode(v),x(a,m),a=m;break}p&&!p.textContent&&(B(p),p=null)}for(;m&&m.nodeType===te&&!m.data;)g=m.nextSibling,B(m),m=g;if(m&&"BR"===m.nodeName&&(g=m.nextSibling,B(m),m=g),!m||m.nodeType===te&&!ue)break;a=m}}a&&(n=e._createRange(a,0)),W(o,o),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed){var r=n.startContainer;if(r.nodeType===ee&&r.firstChild&&!i(r)&&(n.startOffset>=r.childNodes.length?r.lastChild.nodeType===ee?(n.setStart(r.lastChild,r.lastChild.childNodes.length),n.setEnd(r.lastChild,r.lastChild.childNodes.length)):(n.setStart(r.lastChild,r.lastChild.data.length),n.setEnd(r.lastChild,r.lastChild.data.length)):Re(n)),We(n,o)){t.preventDefault();var a,s=De(n,o);if(!s)return;W(s.parentNode,o),a=v(s,o);var c,m=s.parentNode;if(m===o||d(m)?(c=m,m=s):c=m.parentNode,l(m))e.modifyBlocks(pt,n);else if(c.firstElementChild===m||d(m.previousElementSibling))f(m)&&e.modifyBlocks(St,n);else if(a){var C;C=a.parentNode===o||d(a.parentNode)?a:a.parentNode,g(C)?(e._blockKeyEvents=!0,e.confirmDeleteWidget(C.getAttribute("widget-id"),C.getAttribute("widget-type")).then(function(){B(C)}).finally(function(){e._blockKeyEvents=!1})):p(C)||(u(C)||h(C))&&!a.textContent.trim()||!C.isContentEditable?B(C):K(a,s,n)}W(o,o),e.setSelection(n),e._updatePath(n,!0)}else e.setSelection(n),setTimeout(function(){Ke(e)},0)}else t.preventDefault(),Ae(n,o),Ke(e,n)},delete:function(e,t,n){var o,r,i,a,s,l,f=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Me(n,f)){if(t.preventDefault(),!(o=De(n,f)))return;W(o.parentNode,f),r=C(o,f);var h,m;if(o.parentNode===f||d(o.parentNode)?(h=o,m=o.parentNode):(h=o.parentNode,m=h.parentNode),d(h.nextElementSibling)||m.lastElementChild===h&&(!c(m)||d(m.nextElementSibling)));else if(r){var v;v=r.parentNode===f||d(r.parentNode)?r:r.parentNode,g(v)?(e._blockKeyEvents=!0,e.confirmDeleteWidget(v.getAttribute("widget-id"),v.getAttribute("widget-type")).then(function(){B(v)}).finally(function(){e._blockKeyEvents=!1})):p(v)||!v.isContentEditable?B(v):u(h)&&!o.textContent.trim()?(B(h),n.setStart(r,0),Re(n)):K(o,r,n),W(f,f),e.setSelection(n),e._updatePath(n,!0)}}else{if(i=n.cloneRange(),Ue(n,e._root),a=n.endContainer,s=n.endOffset,a.nodeType===ee&&(l=a.childNodes[s])&&"IMG"===l.nodeName)return t.preventDefault(),B(l),Re(n),void Ke(e,n);e.setSelection(i),setTimeout(function(){Ke(e)},0)}else t.preventDefault(),Ae(n,f),Ke(e,n)},space:function(e,t,n){var o,r;e._recordUndoState(n),bt(n.startContainer),e._getRangeAndRemoveBookmark(n),o=n.endContainer,r=o.parentNode,n.collapsed&&"A"===r.nodeName&&!o.nextSibling&&n.endOffset===E(o)&&n.setStartAfter(r),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};de&&ce&&(Qe["meta-left"]=function(e,t){t.preventDefault();var n=lt(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Qe["meta-right"]=function(e,t){t.preventDefault();var n=lt(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),de||(Qe.pageup=function(e){e.moveCursorToStart()},Qe.pagedown=function(e){e.moveCursorToEnd()});var Ge=function(e){return function(t,n){var o=A(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(O(t)),o}},je={SPAN:function(t,n){var o=e.createTextNode(t.textContent);return n.replaceChild(o,t),o},STRONG:Ge("B"),EM:Ge("I"),IMG:function(n,o,r){if("page-break"===n.className)return n;var i=A(e,"P",{class:"smw-missing-image"}),a=[n.src,n.alt,n.title].filter(function(e){return e!==t||""!==e});return i.innerHTML="<br><b>Missing image: "+a.join("<br>")+"</b><br>",o.replaceChild(i,n),r&&r(n),i},A:function(e,t){return e},LI:function(t,n){var o;if("P"!==t.firstChild.nodeName){var r=A(e,"P",{},[e.createTextNode(t.textContent)]);o=A(e,"LI",{},[r]),n.replaceChild(o,t)}else o=t;return o},BLOCKQUOTE:function(e){return"aside"!==e.className&&(e.className="blockquote"),e}},Ze=/^(A|BLOCKQUOTE|H[1-4]|LI|UL|OL|P|ASIDE|MYWO-CONTENT-WIDGET|SMW-CONTENT-WIDGET|DIV|BR)$/,ze=/^(MYWO-CONTENT-WIDGET)$/,Ve=/^(?:HEAD|META|STYLE)/,$e=new n(null,4|re,function(){return!0}),Ye=function n(o,r,a){var s,l,d,c,f,u,h,p,g,m,v,C,_=o.childNodes;for(s=o;i(s);)s=s.parentNode;for($e.root=s,l=0,d=_.length;l<d;l+=1)if(c=_[l],f=c.nodeName,u=c.nodeType,h=je[f],u===ee){if(c.setAttribute("style",""),p=c.childNodes.length,h){var S=h(c,o,a);if(!S){l-=1,d-=1,o.removeChild(c);continue}c=S,c.nodeType===te&&(p=t)}else{if(Ve.test(f)){o.removeChild(c),l-=1,d-=1;continue}if(!Ze.test(f)&&!i(c)){var N=c.textContent||c.innerText;o.replaceChild(e.createTextNode(N),c),a&&a(c);continue}}p&&!ze.test(f)&&n(c,r||"PRE"===f,a)}else{if(u===te){if(v=c.data,g=!_e.test(v.charAt(0)),m=!_e.test(v.charAt(v.length-1)),r||!g&&!m)continue;if(g){for($e.currentNode=c;(C=$e.previousPONode())&&!("IMG"===(f=C.nodeName)||"#text"===f&&/\S/.test(C.data));)if(!i(C)){C=null;break}v=v.replace(/^\s+/g,C?" ":"")}if(m){for($e.currentNode=c;(C=$e.nextNode())&&!("IMG"===f||"#text"===f&&/\S/.test(C.data));)if(!i(C)){C=null;break}v=v.replace(/\s+$/g,C?" ":"")}if(v){c.data=v;continue}}o.removeChild(c),l-=1,d-=1}return o},Xe=function e(t){for(var n,o=t.childNodes,a=o.length;a--;)n=o[a],n.nodeType!==ee||r(n)?n.nodeType!==te||n.data||t.removeChild(n):(e(n),i(n)&&!n.firstChild&&t.removeChild(n))},Je=function(e){return e.nodeType===ee?"BR"===e.nodeName:_e.test(e.data)},et=function(e){for(var t,o=e.parentNode;i(o);)o=o.parentNode;return t=new n(o,4|re,Je),t.currentNode=e,!!t.nextNode()},tt=function(e,t){var n,o,r,a=e.querySelectorAll("BR"),s=[],l=a.length;for(n=0;n<l;n+=1)s[n]=et(a[n]);for(;l--;)o=a[l],(r=o.parentNode)&&(s[l]?i(r):B(o))},nt=function(e){var t=e.clipboardData,n=this.getSelection(),o=this.createElement("div"),r=this._root,i=this;this.saveUndoState(n),he||le||!t?setTimeout(function(){try{W(r,r)}catch(e){i.didError(e)}},0):(Ue(n,r),o.appendChild(Ae(n,r)),t.setData("text/html",o.innerHTML),t.setData("text/plain",o.innerText||o.textContent),e.preventDefault(),W(r,r)),this.setSelection(n)},ot=function(e){var t=e.clipboardData,n=this.getSelection(),o=this.createElement("div");he||le||!t||(o.appendChild(n.cloneContents()),t.setData("text/html",o.innerHTML),t.setData("text/plain",o.innerText||o.textContent),e.preventDefault())},rt=function(e){var t,n,o,r,i,a=e.clipboardData,s=a&&a.items,l=!1,d=!1,c=null,f=this;if(!he&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],"text/html"===(o=n.type))return void n.getAsString(function(e){f.insertHTML(e,!0)});"text/plain"===o&&(c=n),/^image\/.*/.test(o)&&(d=!0)}return void(d?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):c&&n.getAsString(function(e){f.insertPlainText(e,!0)}))}if(r=a&&a.types,!he&&r&&(Se.call(r,"text/html")>-1||!ce&&Se.call(r,"text/plain")>-1&&Se.call(r,"text/rtf")<0))return e.preventDefault(),void((i=a.getData("text/html"))?this.insertHTML(i,!0):((i=a.getData("text/plain"))||(i=a.getData("text/uri-list")))&&this.insertPlainText(i,!0));this._awaitingPaste=!0;var u=this._doc.body,h=this.getSelection(),p=h.startContainer,g=h.startOffset,m=h.endContainer,v=h.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});u.appendChild(C),h.selectNodeContents(C),this.setSelection(h),setTimeout(function(){try{f._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,B(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=f._createRange(p,g,m,v),f.setSelection(t),n&&f.insertHTML(n,!0)}catch(e){f.didError(e)}},0)},it=[],at=Z.prototype;at.setConfig=function(e){return e=j({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null}},e),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},at.createElement=function(e,t,n){return A(this._doc,e,t,n)},at.createDefaultBlock=function(e,t){var n=this._config;return L(this.createElement(n.blockTag,n.blockAttributes,e),this._root)},at.didError=function(e){console.error(e)},at.getDocument=function(){return this._doc},at.getRoot=function(){return this._root};var st={pathChange:1,select:1,input:1,undoStateChange:1,dragover:1,drop:1};at.fireEvent=function(e,t){var n,o,r=this._events[e];if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),n=r.length;n--;){o=r[n];try{o.handleEvent?o.handleEvent(t):o.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},at.destroy=function(){var e,t=this._root,n=this._events;for(e in n)st[e]||t.removeEventListener(e,this,!0);this._mutation&&this._mutation.disconnect(),this._doc.removeEventListener("selectionchange",this._onSelectionChange,!0);for(var o=it.length;o--;)it[o]===this&&it.splice(o,1)},at.handleEvent=function(e){this.fireEvent(e.type,e)},at.addEventListener=function(e,t){var n=this._events[e];return t?(n||(n=this._events[e]=[],st[e]||this._root.addEventListener(e,this,!0)),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},at.removeEventListener=function(e,t){var n,o=this._events[e];if(o){for(n=o.length;n--;)o[n]===t&&o.splice(n,1);o.length||(delete this._events[e],st[e]||this._root.removeEventListener(e,this,!0))}return this},at._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var r=this._doc.createRange();return r.setStart(e,t),n?r.setEnd(n,o):r.setEnd(e,t),r},at.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=ie,Be(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),H(n,{startContainer:e.startContainer,endContainer:e.endContainer,startOffset:e.startOffset,endOffset:e.endOffset})),o},at._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Re(n),this.setSelection(n),this},at.moveCursorToStart=function(){return this._moveCursorTo(!0)},at.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var lt=function(e){return e._win.getSelection()||null};at.setSelection=function(e){if(e){this._restoreSelection=!1,this._lastSelection=e,le&&this._win.focus();var t=lt(this);t&&(t.removeAllRanges(),t.addRange(e))}return this},at.getSelection=function(){var e,t,n,o=lt(this),i=this._root;return o&&o.rangeCount&&(e=o.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&r(t)&&e.setStartBefore(t),n&&r(n)&&e.setEndBefore(n)),e&&k(i,e.commonAncestorContainer)?this._lastSelection=e:e=this._lastSelection,e||(e=this._createRange(i.firstChild,0)),e},
at.getSelectedText=function(){var e,t=this.getSelection(),o=new n(t.commonAncestorContainer,4|re,function(e){return we(t,e,!0)}),r=t.startContainer,a=t.endContainer,s=o.currentNode=r,l="",d=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===te?(e=s.data)&&/\S/.test(e)&&(s===a&&(e=e.slice(0,t.endOffset)),s===r&&(e=e.slice(t.startOffset)),l+=e,d=!0):"BR"===s.nodeName||d&&!i(s)?(l+="\n",d=!1):("HR"===s.nodeName||d&&!i(s))&&(l+="\n\n\n",d=!1),s=o.nextNode();return l},at.getPath=function(){return this._path};var dt=function(e){for(var t,o,r,a=new n(e,4,function(){return!0},!1);o=a.nextNode();)if(o.data)for(;(r=o.data.indexOf(ie))>-1;){if(1===o.length){do{t=o.parentNode,t.removeChild(o),o=t,a.currentNode=t}while(i(o)&&!E(o));break}o.deleteData(r,1)}};at._didAddZWS=function(){this._hasZWS=!0},at._removeZWS=function(){this._hasZWS&&(dt(this._root),this._hasZWS=!1)},at._updatePath=function(e,t){var n,o=e.startContainer,r=e.endContainer;(t||o!==this._lastAnchorNode||r!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=r,n=o&&r?o===r?y(r,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),e.collapsed||this.fireEvent("select")},at._updatePathOnEvent=function(){this._updatePath(this.getSelection())},at._updateUndoState=function(e){this._canUndo=e.canUndo,this._canRedo=e.canRedo},at.focus=function(){return this._root.focus(),this},at.blur=function(){return this._root.blur(),this};at._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),o=this.createElement("INPUT",{id:"squire-selection-end",type:"hidden"});Be(e,n),e.collapse(!1),Be(e,o),2&n.compareDocumentPosition(o)&&(n.id="squire-selection-end",o.id="squire-selection-start",t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},at._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),o=t.querySelector("#squire-selection-end");if(n&&o){var r,i=n.parentNode,a=o.parentNode,s={startContainer:i,endContainer:a,startOffset:Se.call(i.childNodes,n),endOffset:Se.call(a.childNodes,o)};i===a&&(s.endOffset-=1),B(n),B(o),H(i,s),i!==a&&H(a,s),e||(e=this._doc.createRange()),e.setStart(s.startContainer,s.startOffset),e.setEnd(s.endContainer,s.endOffset),r=e.collapsed,r&&(i=e.startContainer,i.nodeType===te&&(a=i.childNodes[e.startOffset],a&&a.nodeType===te||(a=i.childNodes[e.startOffset-1]),a&&a.nodeType===te&&(e.setStart(a,0),e.collapse(!0))))}return e||null},at._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},at._docWasChanged=function(){if(Ce&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),-1===this._undoIndex&&this.saveUndoState(),this.fireEvent("input")},at._recordUndoState=function(e){if(!this._isInUndoState){var t=this._undoIndex+=1,n=this._undoStack,o=this._undoScrollTopStack;t<this._undoStackLength&&(n.length=this._undoStackLength=t,o.length=this._undoStackLength=t),W(this._root,this._root),e&&this._saveRangeToBookmark(e),n[t]=this._getHTML(),o[t]=0===t?null:this._doc.documentElement.scrollTop||this._doc.body.scrollTop,this._undoStackLength+=1,this._isInUndoState=!0}},at.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e),this._getRangeAndRemoveBookmark(e)),this},at.undo=function(){if(this._undoIndex>0||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1;var e=this._undoScrollTopStack[this._undoIndex];null===e&&(e=this._doc.documentElement.scrollTop||this._doc.body.scrollTop),this._setHTML(this._undoStack[this._undoIndex]);var t=this._getRangeAndRemoveBookmark();t&&this.setSelection(t),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input"),this._doc.documentElement.scrollTop=e,this._doc.body.scrollTop=e;var n=this;setTimeout(function(){n._doc&&n._doc.documentElement&&(n._doc.documentElement.scrollTop=e,n._doc.body.scrollTop=e)},16)}return this.focus()},at.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1;var n=this._undoScrollTopStack[this._undoIndex];this._setHTML(this._undoStack[this._undoIndex]);var o=this._getRangeAndRemoveBookmark();o&&this.setSelection(o),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input"),this._doc.documentElement.scrollTop=n,this._doc.body.scrollTop=n;var r=this;setTimeout(function(){r._doc&&r._doc.documentElement&&(r._doc.documentElement.scrollTop=n,r._doc.body.scrollTop=n)},16)}return this.focus()},at.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===te&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===te&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var r,i,a=this._root,s=o.commonAncestorContainer;if(N(s,a,e,t))return!0;if(s.nodeType===te)return!1;r=new n(s,4,function(e){return we(o,e,!0)},!1);for(var l=!1;i=r.nextNode();){if(!N(i,a,e,t))return!1;l=!0}return l},at.getFontInfo=function(e){var n,o,r,i={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return i;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===te)for(n.nodeType===te&&(n=n.parentNode);a<4&&n;)(o=n.style)&&(!i.color&&(r=o.color)&&(i.color=r,a+=1),!i.backgroundColor&&(r=o.backgroundColor)&&(i.backgroundColor=r,a+=1),!i.family&&(r=o.fontFamily)&&(i.family=r,a+=1),!i.size&&(r=o.fontSize)&&(i.size=r,a+=1)),n=n.parentNode;return i},at._addFormat=function(e,t,o){var r,i,a,s,l,d,c,f=this._root;if(o.collapsed)r=L(this.createElement(e,t),f),Be(o,r),o.setStart(r.firstChild,r.firstChild.length),o.collapse(!0);else{if(i=new n(o.commonAncestorContainer,4|re,function(e){return(e.nodeType===te||"BR"===e.nodeName||"IMG"===e.nodeName)&&we(o,e,!0)},!1),a=o.startContainer,l=o.startOffset,s=o.endContainer,d=o.endOffset,i.currentNode=a,i.filter(a)||(a=i.nextNode(),l=0),!a)return o;do{c=i.currentNode,!N(c,f,e,t)&&(c===s&&c.length>d&&c.splitText(d),c===a&&l&&(c=c.splitText(l),s===a&&(s=c,d-=l),a=c,l=0),r=this.createElement(e,t),x(c,r),r.appendChild(c))}while(i.nextNode());s.nodeType!==te&&(c.nodeType===te?(s=c,d=c.length):(s=c.parentNode,d=1)),o=this._createRange(a,l,s,d)}return o},at._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var r,a=this._doc;n.collapsed&&(me?(r=a.createTextNode(ie),this._didAddZWS()):r=a.createTextNode(""),Be(n,r));for(var s=n.commonAncestorContainer;i(s);)s=s.parentNode;var l=n.startContainer,d=n.startOffset,c=n.endContainer,f=n.endOffset,u=[],h=function(e,t){if(!we(n,e,!1)){var o,r,i=e.nodeType===te;if(!we(n,e,!0))return void("INPUT"===e.nodeName||i&&!e.data||u.push([t,e]));if(i)e===c&&f!==e.length&&u.push([t,e.splitText(f)]),e===l&&d&&(e.splitText(d),u.push([t,e]));else for(o=e.firstChild;o;o=r)r=o.nextSibling,h(o,t)}},p=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return we(n,o,!0)&&S(o,e,t)});o||p.forEach(function(e){h(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];x(n,t),t.appendChild(n)}),p.forEach(function(e){x(e,O(e))}),this._getRangeAndRemoveBookmark(n),r&&n.collapse(!1);var g={startContainer:n.startContainer,startOffset:n.startOffset,endContainer:n.endContainer,endOffset:n.endOffset};return H(s,g),n.setStart(g.startContainer,g.startOffset),n.setEnd(g.endContainer,g.endOffset),n},at.changeFormat=function(e,t,n,o){if(n||(n=this.getSelection()))return this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),Ce||this._docWasChanged(),this};var ct={DT:"DD",DD:"DT",LI:"LI"},ft=function(e,t,n,o){var r=ct[t.nodeName],i=null,a=q(n,o,t.parentNode,e._root),s=e._config;return r||(r=s.blockTag,i=s.blockAttributes),S(a,r,i)||(t=A(a.ownerDocument,r,i),a.dir&&(t.dir=a.dir),x(a,t),t.appendChild(O(a)),a=t),a},ut=function(e,t,n){var o=ft(e,t,n.startContainer,n.startOffset),r=o.firstElementChild,i=t.parentNode;return i.insertBefore(r,o),i.removeChild(o),r};at.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,r=De(n,o),i=Ie(n,o);if(r&&i)do{if(e(r)||r===i)break}while(r=C(r,o));return t&&(this.setSelection(n),this._updatePath(n,!0),Ce||this._docWasChanged()),this},at.modifyBlocks=function(e,t,n,o,r,i){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(i||t):this._recordUndoState(i||t);var a,s,l,d=this._root;return n&&(l=T(t.commonAncestorContainer,n,o)),l?(t.setStart(l,0),t.setEnd(l,l.childNodes.length)):Fe(t,d),s=r?d:N(t.commonAncestorContainer,d,"BLOCKQUOTE",{class:"aside"})||d,Ue(t,s),a=xe(t,s,d),Be(t,e.call(this,a)),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),Ce||this._docWasChanged(),this};var ht=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},pt=function(e){var t=e.querySelectorAll("blockquote"),n=t[t.length-1];return x(n,O(n)),e},gt=function(e,n,o,r){for(var i,a,s,l,d=r!=t?r:o.toLowerCase(),c=m(n,e._root),f=e._config.tagAttributes,u=f[d]||{class:""},h=f.li;i=c.nextNode();)a=i.parentNode.nodeName,"LI"!==a?(l=e.createElement("LI",h),i.dir&&(l.dir=i.dir),(s=i.previousSibling)&&s.nodeName===o?s.appendChild(l):x(i,e.createElement(o,u,[l])),l.appendChild(i)):(i=i.parentNode.parentNode,(a=i.nodeName)===o&&i.getAttribute("class")===u.class||!/^[OU]L$/.test(a)||x(i,e.createElement(o,u,[O(i)])))},mt=function(e){return gt(this,e,"UL"),e},vt=function(e){return gt(this,e,"OL"),e},Ct=function(e){var t,n,o,r,i,a,s,l=e.querySelectorAll("UL, OL");for(t=0,n=l.length;t<n;t+=1){for(r=l[t],i=O(r),a=i.childNodes,o=a.length;o--;)s=a[o],x(s,O(s));W(i,this._root),x(r,i)}return e},_t=function(e){var t,n,o,r,i,a,l=e.querySelectorAll("LI"),d=this._config.tagAttributes,c=d.li;for(t=0,n=l.length;t<n;t+=1)o=l[t],s(o.firstChild)||(r=o.parentNode.nodeName,i=o.previousSibling,i&&(i=i.lastChild)&&i.nodeName===r||(a=d[r.toLowerCase()],x(o,this.createElement("LI",c,[i=this.createElement(r,a)]))),i.appendChild(o));return e},St=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!s(e.firstChild)}).forEach(function(n){var o,r=n.parentNode,i=r.parentNode,a=n.firstChild,l=a;for(n.previousSibling&&(r=q(r,n,i,t));l&&(o=l.nextSibling,!s(l));)i.insertBefore(l,r),l=o;for("LI"===i.nodeName&&a.previousSibling&&q(i,a,i.parentNode,t);n!==e&&!n.childNodes.length;)r=n.parentNode,r.removeChild(n),n=r},this),W(e,t),e};at._ensureBottomLine=function(e){var n=e===t?this._root:e,o=n.lastElementChild;o&&o.nodeName===this._config.blockTag&&a(o)||n.appendChild(this.createDefaultBlock())},at.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},at._getHTML=function(){return this._root.innerHTML},at._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{L(n,t)}while(n=C(n,t));this._ignoreChange=!0},at.getHTML=function(e){var t,n,o,r,i,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ge)for(t=this._root,n=t;n=C(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(r=this._getHTML().replace(/\u200B/g,""),ge)for(i=s.length;i--;)B(s[i]);return a&&this._getRangeAndRemoveBookmark(a),r},at.setHTML=function(e,t,n){var o,r=this._doc.createDocumentFragment(),i=this.createElement("DIV"),a=this._root;for(i.innerHTML=e,r.appendChild(O(i)),n||(Ye(r),tt(r)),this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);if(a.appendChild(r),W(a,a),!t){this._undoIndex=-1,this._undoStack.length=0,this._undoScrollTopStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var s=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);this._lastSelection=s,this._updatePath(s,!0)}return this},at.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),i(e))Be(t,e),t.setStartAfter(e);else{for(var n,o,r=this._root,a=De(t,r)||r;a!==r&&!a.nextSibling;)a=a.parentNode;a!==r&&(n=a.parentNode,o=q(n,a.nextSibling,r,r)),o?r.insertBefore(e,o):(r.appendChild(e),o=this.createDefaultBlock(),r.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Re(t)}return this.focus(),this.setSelection(t),this._updatePath(t),this},at.insertImage=function(e,t){var n=this,o=n.getSelection();n._recordUndoState(o),n._getRangeAndRemoveBookmark(o);var r=this.createElement("IMG",j({src:e},t));this.insertElement(r),n._docWasChanged();var i=n._doc.createRange();return i.selectNode(r),i.collapse(!1),n._recordUndoState(i),n._getRangeAndRemoveBookmark(i),r};var Nt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,bt=function(e,t){for(var o,r,i,a,s,l,d,c=e.ownerDocument,f=new n(e,4,function(e){return!N(e,t,"A")},!1);o=f.nextNode();)for(r=o.data,i=o.parentNode;a=Nt.exec(r);)s=a.index,l=s+a[0].length,s&&(d=c.createTextNode(r.slice(0,s)),i.insertBefore(d,o)),d=c.createElement("A"),d.textContent=r.slice(s,l),d.href=a[1]?/^(?:ht|f)tps?:/.test(a[1])?a[1]:"http://"+a[1]:"mailto:"+a[2],i.insertBefore(d,o),o.data=r=r.slice(l)};at.insertHTML=function(e,t){var n=this.getSelection(),o=this._doc.createDocumentFragment(),r=this.createElement("DIV");r.innerHTML=e,o.appendChild(O(r)),this.saveUndoState(n);try{var i=this._root,a=o,s={fragment:o,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1};bt(o,i);var l=t?this._onPasteErrorCallback:null;for(Ye(o,!1,l),tt(o),Xe(o),o.normalize();a=C(a,i);)L(a,i);t&&this.fireEvent("willPaste",s),s.defaultPrevented||(Le(n,s.fragment,i),Ce||this._docWasChanged(),n.collapse(!1),W(i,i),t&&this._onPasteCallback&&this._onPasteCallback()),this.setSelection(n),this._updatePath(n,!0)}catch(e){this.didError(e)}return this},at.insertPlainText=function(e,t){var n,o,r,i=e.split("\n");for(n=0,o=i.length;n<o;n+=1)r=i[n],r=r.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").replace(/ (?= )/g,"&nbsp;"),n&&n+1<o&&(r="<DIV>"+(r||"<BR>")+"</DIV>"),i[n]=r;return this.insertHTML(i.join(""),t)};var Tt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};at.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},at.underline=Tt("changeFormat",{tag:"U"}),at.strikethrough=Tt("changeFormat",{tag:"S"}),at.subscript=Tt("changeFormat",{tag:"SUB"},{tag:"SUP"}),at.superscript=Tt("changeFormat",{tag:"SUP"},{tag:"SUB"}),at.removeUnderline=Tt("changeFormat",null,{tag:"U"}),at.removeStrikethrough=Tt("changeFormat",null,{tag:"S"}),at.removeSubscript=Tt("changeFormat",null,{tag:"SUB"}),at.removeSuperscript=Tt("changeFormat",null,{tag:"SUP"}),at.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;Be(n,this._doc.createTextNode(e.slice(o)))}return t||(t={}),t.href=e,this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},at.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},at.setFontFace=function(e){return this.changeFormat({tag:"SPAN",attributes:{class:"font",style:"font-family: "+e+", sans-serif;"}},{tag:"SPAN",attributes:{class:"font"}}),this.focus()},at.setFontSize=function(e){return this.changeFormat({tag:"SPAN",attributes:{class:"size",style:"font-size: "+("number"==typeof e?e+"px":e)}},{tag:"SPAN",attributes:{class:"size"}}),this.focus()},at.setTextColour=function(e){return this.changeFormat({tag:"SPAN",attributes:{class:"colour",style:"color:"+e}},{tag:"SPAN",attributes:{class:"colour"}}),this.focus()},at.setHighlightColour=function(e){return this.changeFormat({tag:"SPAN",attributes:{class:"highlight",style:"background-color:"+e}},{tag:"SPAN",attributes:{class:"highlight"}}),this.focus()},at.setTextAlignment=function(e){return this.forEachBlock(function(t){t.className=(t.className.split(/\s+/).filter(function(e){return!/align/.test(e)}).join(" ")+" align-"+e).trim(),t.style.textAlign=e},!0),this.focus()},at.setTextDirection=function(e){return this.forEachBlock(function(t){t.dir=e},!0),this.focus()},at.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!a(n);)n=n.parentNode;if(n||(Fe(e,t),n=t),n.nodeType===te)return this;this.saveUndoState(e),Ue(e,n);for(var o,r,i,s=n.ownerDocument,l=e.startContainer,d=e.startOffset,c=e.endContainer,f=e.endOffset,u=s.createDocumentFragment(),h=s.createDocumentFragment(),p=q(c,f,n,t),g=q(l,d,n,t);g!==p;)o=g.nextSibling,u.appendChild(g),g=o;return Y(this,u,h),h.normalize(),g=h.firstChild,o=h.lastChild,i=n.childNodes,g?(n.insertBefore(h,p),d=Se.call(i,g),f=Se.call(i,o)+1):(d=Se.call(i,p),f=d),r={startContainer:n,startOffset:d,endContainer:n,endOffset:f},H(n,r),e.setStart(r.startContainer,r.startOffset),e.setEnd(r.endContainer,r.endOffset),Re(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},at.increaseQuoteLevel=Tt("modifyBlocks",ht);Tt("modifyBlocks",pt);at.makeUnorderedList=Tt("modifyBlocks",mt),at.makeOrderedList=Tt("modifyBlocks",vt),at.removeList=Tt("modifyBlocks",Ct),at.increaseListLevel=Tt("modifyBlocks",_t),at.decreaseListLevel=Tt("modifyBlocks",St);var kt=function(e,t){return Object.keys(e).reduce(function(n,o){return e[o].forEach(function(e){-1!==t.indexOf(e)&&(n[e]=o)}),n},{})},yt=function(e,n){var o=e.blockquote!=t?"BLOCKQUOTE."+e.blockquote.class:"BLOCKQUOTE",r="BLOCKQUOTE."+e.aside.class,i=e.ul!=t?"UL."+e.ul.class:"UL",a="UL."+e.noLabels.class,s="IMG."+e.pageBreak.class,l={B:"strong",I:"em",H1:"heading",H2:"heading",H3:"heading",H4:"heading",OL:"list",A:"link","MYWO-CONTENT-WIDGET":"smwWidget",BR:"br"};l[o]="blockquote",l[r]="aside",l[i]="list",l[a]="list",l[s]="hr";for(var d in l)-1===n.indexOf(l[d])&&delete l[d];return l},Et=function(e){var t="H"+e;return function(e){return Lt(this,e,t)}},Bt=function(e){return gt(this,e,"UL","noLabels"),e},xt=function(e){var t=e.querySelector("blockquote.aside");if(t){var n=At(this,Array.prototype.slice.call(t.childNodes),"BLOCKQUOTE","blockquote");return t.appendChild(n),e}return At(this,e,"BLOCKQUOTE","blockquote")},Ot=function(e){return At(this,e,"BLOCKQUOTE","aside")},At=function(e,n,o,r){var r=r!=t?r:o,i=e._config.tagAttributes[r];return n.constructor===Array?e.createElement(o,i,n):null===n.querySelector(o+"."+i.class)?e.createElement(o,i,[n]):n},Lt=function(e,t,n){var o,r,i,a=e._config.tagAttributes,s=a[n];if((r=t.querySelectorAll("h1, h2, h3, h4"))&&0!==r.length){for(var l=0;l<r.length;l++){o=r[l];x(o,e.createElement(n,s,o.childNodes))}return t}return i=[t],o=e.createElement(n,s,i)},wt=function(e){for(var t=e.querySelectorAll("h1, h2, h3, h4"),n=0;n<t.length;n++){var o=t[n];x(o,O(o))}return e},Rt=function(e){var t=e.querySelectorAll("blockquote"),n=this._config.tagAttributes.blockquote;return Dt(t,n.class),e},Ut=function(e){var t=e.querySelectorAll("blockquote"),n=this._config.tagAttributes.aside;return Dt(t,n.class),e},Dt=function(e,t){Array.prototype.filter.call(e,function(e){return e.className===t}).forEach(function(e){x(e,O(e))})};at.removeBlockquotes=function(){var e=this.getSelection();return this.modifyBlocks(Rt,e,"BLOCKQUOTE"),this.focus()},at.removeAsides=function(){var e=this.getSelection();return this.modifyBlocks(Ut,e,"BLOCKQUOTE",{class:"aside"},!0),this.focus()},at.insertSoftBreak=function(){var e=this,t=e.getSelection();if(!It(e,t))return void e.focus();var n=e.createElement("BR");return e._recordUndoState(t),e._getRangeAndRemoveBookmark(t),Le(t,n,e._root),Ce||e._docWasChanged(),t.collapse(!1),e.setSelection(t),e._updatePath(t,!0),e.focus()};var It=function(e,t){var n=!0;if(t.collapsed){var o,r,i=t.startContainer;b(i,e._root,h)?n=!1:i.nodeType===te?(o=i.previousSibling,r=i.nextSibling,(i.data.slice(0,t.startOffset).trim()||o&&"BR"!==o.nodeName)&&(i.data.slice(t.endOffset).trim()||!r||r.parentNode.lastChild===r||"BR"!==r.nodeName)||(n=!1)):(i=i.childNodes[t.startOffset])&&(o=i.previousSibling,r=i.nextSibling,"BR"===i.nodeName&&(!o||"BR"===o.nodeName||r&&r.parentNode.lastChild!==r&&"BR"===r.nodeName)&&(n=!1))}else n=!1;return n};at.insertPageBreak=function(){var e=this,t=e.getSelection(),n=this._config.tagAttributes,o=n.pageBreak,r=this.createElement("IMG",o),i=e.createDefaultBlock([r]);if(i.setAttribute("class",o.class+"-container"),e._recordUndoState(t),e._getRangeAndRemoveBookmark(t),t.collapsed){var a=N(t.endContainer,e._root,"P");a.parentNode.insertBefore(e.createDefaultBlock([]),i.nextSibling),a.parentNode.insertBefore(i,a.nextSibling),a.parentNode.insertBefore(e.createDefaultBlock([]),i.nextSibling)}else{var s=t.startContainer.parentNode;s.parentNode.insertBefore(i,s)}return i.setAttribute("contenteditable","false"),t.setStart(i.nextSibling,0),e.focus(),e.setSelection(t),e._updatePath(t),Ce||this._docWasChanged(),e},at.bold=function(){return Mt(this,{tag:"B"},{tag:"B"})},at.italic=function(){return Mt(this,{tag:"I"},{tag:"I"})},at.removeBold=function(){return Mt(this,null,{tag:"B"})},at.removeItalic=function(){return Mt(this,null,{tag:"I"})};var Pt=function(e,t){e._removeZWS();var n=e.getSelection();return e.hasFormat(t,null,n)?Mt(e,null,{tag:t},n):Mt(e,{tag:t},null,n)},Wt=function(e,n,o,r,i){var a=e.getSelection(),s=o!=t?o:null;return e.hasFormat(n,s,a)?i():r()},Mt=function(e,t,n,o){o||(o=e.getSelection());var r=o.startContainer,i=(o.endContainer,o.startOffset),a=o.endOffset;r.nodeType;return o.collapsed&&i<r.textContent.length&&a<r.textContent.length&&r.nodeType===te?(Ee(o),e.changeFormat(t,n,o)):e.changeFormat(t,n,o),e.focus()},Ft=function(e,t){return-1!==e._config.inlineMarkedTypes.indexOf(t)};at.widgetRangeSelectNextParagraph=function(e){var t;if(t=b(e.startContainer,this._root,g)){for(var n=t.nextSibling;n&&!u(n);)n=C(n,this._root);var o=this._createRange(n,0);Re(o),o.collapse(!0),this.setSelection(o)}return this.focus()},at.isAllowedIn=function(e,t,n){var o=[],r=e._classifications.inlineWithText.concat(e._classifications.inlineWithAtomic);switch(e._allowedContent[n]){case"containers":o=r.concat(e._allowedBlocks[n]);break;case"blockAtomic":o=[];break;case"blockWithText":o=r;break;case"inlineWithAtomic":o=[];break;case"inlineWithText":o=e._classifications.inlineWithText;break;default:o=[]}return"heading"===n&&(o=o.filter(function(e){return"br"!=e})),-1!==o.indexOf(t)};var qt=function(e,t){return e._translateToSmw[t]};at.h1=Tt("modifyBlocks",Et(1)),at.h2=Tt("modifyBlocks",Et(2)),at.h3=Tt("modifyBlocks",Et(3)),at.h4=Tt("modifyBlocks",Et(4)),at.removeHeader=Tt("modifyBlocks",wt),at.makeUnlabeledList=Tt("modifyBlocks",Bt),at.createBlockQuote=Tt("modifyBlocks",xt),at.createAside=function(){var e,t=this.getSelection(),n=t.cloneRange(),o=!1;e=b(n.startContainer,this._root,c),e&&(n.setStartBefore(e),o=!0),e=b(n.endContainer,this._root,c),e&&(n.setEndAfter(e),o=!0),this.modifyBlocks(Ot,n,null,null,!0,o&&t),this.focus()},at.addDefaultBlock=function(){this._ensureBottomLine()},at.mergeInlines=function(){var e=this._root,t=this._doc.createRange();t.selectNode(e),H(e,t)},at.fixContainers=function(){return W(this._root,this._root),this},at.toggleStrong=function(){return Pt(this,"B"),this.focus()},at.toggleEm=function(){return Pt(this,"I"),this.focus()},at.toggleHr=function(){return this.insertPageBreak(),this.focus()},at.toggleBlockquote=function(){var e=this,t=e._config.tagAttributes.blockquote;return Wt(e,"BLOCKQUOTE",t,function(){return e.createBlockQuote()},function(){return e.removeBlockquotes()}),this.focus()},at.toggleAside=function(){var e=this,t=e._config.tagAttributes.aside;return Wt(e,"BLOCKQUOTE",t,function(){return e.createAside()},function(){return e.removeAsides()}),this.focus()},at.setHeading=function(e){return 0===e?this.modifyBlocks(wt):this.modifyBlocks(Et(e))},at.setLink=function(e,t){var n=this.getSelection();this.saveUndoState(n);var o=J(this._root,"A",null,n);if(o.length>0)o[0].setAttribute("href",e),t&&o[0].setAttribute("title",t);else{n.collapsed&&Ee(n);var r;r=t?{href:e,title:t}:{href:e};var i=n.extractContents(),a=this.createElement("A",r,Array.prototype.slice.call(i.childNodes));Be(n,a)}return Ce||this._docWasChanged(),this.focus()},at.canUndo=function(){return this._canUndo},at.canRedo=function(){return this._canRedo},at.setListFormatting=function(e){var t=this.getSelection(),n=t.collapsed;e?"ordered"===e?this.modifyBlocks(vt,t,"[OU]L"):"bulleted"===e?this.modifyBlocks(mt,t,"[OU]L"):"noLabels"===e&&this.modifyBlocks(Bt,t,"[OU]L"):this.modifyBlocks(Ct,t,"[OU]L");var o=this.getSelection();if(n&&!o.collapsed){var r=De(o,this._root);if(r){var i=this._doc.createRange();i.setStart(r,0),i.collapse(!0),this.setSelection(i),console.log("Fixing selection",i)}}return this.focus()},at.setWidget=function(e){return this.insertHTML(e),this};var Ht=function(e,t){switch(t){case"UL."+e._config.tagAttributes.noLabels.class:return"noLabels";case"UL."+e._config.tagAttributes.ul.class:return"bulleted";case"OL":return"ordered"}};at.getFormattingInfoFromCurrentSelection=function(){var e=this,n=e._validTags,o=e.getSelection(),r=o.commonAncestorContainer,i=S(r,"BODY"),a=S(r,"BLOCKQUOTE",e._config.tagAttributes.aside),s={},l={},d=n.map(function(n){var r=qt(e,n),i=n.split("."),a=i[0],s=i[1],d=s===t?e._config.tagAttributes[a]:{class:s},c=J(e._root,a,d,o);return c.length>0&&(l[r]?l[r]=l[r].concat(c):l[r]=c),{squireTag:n,smwTag:qt(e,n),elements:c}}),c=Object.keys(l).filter(function(t){return!Ft(e,t)});return d.forEach(function(t){var n=t.smwTag;if(!s[n]||!s[n].enabled&&!s[n].allowed){var r={};switch(n){case"blockquote":case"aside":case"heading":case"list":case"link":case"smwWidget":case"hr":r.enabled=1===t.elements.length&&l[n]&&1===l[n].length;break;default:r.enabled=l[n]&&l[n].length>0}var d=r.enabled||c.every(function(t){return e.isAllowedIn(e,n,t)||e.isAllowedIn(e,t,n)});if(d)switch(n){case"aside":d=1===t.elements.length&&!i||0===t.elements.length;break;case"hr":d=!l.aside&&o.collapsed;break;case"link":if(d=!1,!i&&!a&&t.elements.length<=1)if(r.enabled||!o.collapsed)d=!0;else if(o.collapsed){var f=o.cloneRange();Ee(f),f.collapsed||(d=!0)}break;case"smwWidget":case"br":d=o.collapsed;break;default:d=!i&&!a}if(r.allowed=d,r.enabled)switch(n){case"list":r.listType=Ht(e,t.squireTag);break;case"heading":r.depth=t.squireTag[1];break;case"link":r.href=t.elements[0].getAttribute("href"),r.title=t.elements[0].title}s[n]=r}}),s},delete at.underline,delete at.strikethrough,delete at.subscript,delete at.superscript,delete at.removeUnderline,delete at.removeStrikethrough,delete at.removeSubscript,delete at.removeSuperscript,delete at.increaseListLevel,delete at.increaseQuoteLevel,"object"==typeof exports?module.exports=Z:"function"==typeof define&&define.amd?define(function(){return Z}):(ae.Squire=Z,top!==ae&&"true"===e.documentElement.getAttribute("data-squireinit")&&(ae.editor=new Z(e),ae.onEditorLoad&&(ae.onEditorLoad(ae.editor),ae.onEditorLoad=null)))}(document);