!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function r(e,t){var n=e.commonAncestorContainer.ownerDocument.createTreeWalker(e.commonAncestorContainer,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT);1===e.startContainer.nodeType?n.currentNode=e.startContainer.childNodes[e.startOffset]:n.currentNode=e.startContainer;var o;o=1===e.endContainer.nodeType?e.endContainer.childNodes[e.endOffset]:e.endContainer;var r=null;do{t(n.currentNode)&&(r=n.currentNode)}while(!r&&n.currentNode!==o&&n.nextNode());return r}function i(e){return e.nodeType===oe&&!!Ee[e.nodeName]}function a(e){return ke.test(e.nodeName)}function s(e){var t=e.nodeType;return t===oe?h(e):t===ae&&(!a(e)&&o(e.childNodes,a))}function l(e){var t=e.nodeType;return!(t!==oe&&t!==ae||a(e)||s(e))}function d(e){return e&&"BLOCKQUOTE.blockquote"===W(e)}function c(e){return e&&"BLOCKQUOTE.aside"===W(e)}function f(e){return e&&/^[OU]L$/.test(e.nodeName)}function u(e){return e&&"LI"===e.nodeName}function h(e){var t=W(e);return e&&"P"===t||"P.paragraph"===t}function p(e){return e&&/^H\d$/.test(e.nodeName)}function g(e){return e&&"P.page-break-container"===W(e)}function m(e){return e&&"MYWO-CONTENT-WIDGET"===e.nodeName}function v(e,t){var o=new n(t,se,s);return o.currentNode=e,o}function C(e,t){return e=v(e,t).previousNode(),e!==t?e:null}function _(e,t){return e=v(e,t).nextNode(),e!==t?e:null}function N(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function S(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function b(e,t,n,o){for(;e&&e!==t;){if(S(e,n,o))return e;e=e.parentNode}return null}function T(e,t,n){for(;e&&e!==t;){if(n(e))return e;e=e.parentNode}return null}function y(e,t,n){do{if(e.nodeName.match("^"+t)&&(!n||S(e,e.nodeName,n)))return e}while(e=e.parentNode);return null}function k(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function E(e,t){var n,o,r,i,a="";return e&&e!==t&&(a=E(e.parentNode,t),e.nodeType===oe&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(r=o.split(/\s\s*/),r.sort(),a+=".",a+=r.join(".")),(i=e.dir)&&(a+="[dir="+i+"]"))),a}function B(e){return e.nodeType===oe?e.childNodes.length:e.length||0}function x(e){var t=e.parentNode;return t&&t.removeChild(e),e}function O(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function A(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function L(e,n,o,r){var i,a,s,l=e.createElement(n);if(o instanceof Array&&(r=o,o=null),o)for(i in o)o[i]!==t&&l.setAttribute(i,o[i]);if(r)for(a=0,s=r.length;a<s;a+=1)l.appendChild(r[a]);return l}function w(e,t){var n,o,r=e.ownerDocument,l=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=z(r).createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===re)return l;if(e.parentNode&&!e.isContentEditable)return l;if(a(e)){for(o=e.firstChild;_e&&o&&o.nodeType===re&&!o.data;)e.removeChild(o),o=e.firstChild;o||(_e?(n=r.createTextNode(le),z(r)._didAddZWS()):n=r.createTextNode(""))}else if(Ce){for(;e.nodeType!==re&&!i(e);){if(!(o=e.firstChild)){n=r.createTextNode("");break}e=o}e.nodeType===re?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(r.createTextNode(""),e)}else if(s(e)&&e.lastChild&&"BR"!==e.lastChild.nodeName)n=L(r,"BR");else if(!e.querySelector("BR"))for(n=L(r,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(t){z(r).didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return l}function R(e,t,n){var o,r,i;h(e.firstChild)?o=e.firstChild:(o=L(t,n.blockTag,n.blockAttributes),e.insertBefore(o,e.firstChild));for(var r=o.nextSibling;r;)i=r.nextSibling,a(r)?o.appendChild(r):r.nodeType===oe&&(x(r),o.appendChild(A(r))),r=i}function U(e,t,n,o){"LI"===t.nodeName&&(t=t.parentNode),D(e,n._translateToSmw[W(t)],n,!0),w(e,n._root)}function D(e,t,n,o){for(var r,s,l=e.firstChild;l;){if(r=!1,l.nodeType===oe)if(!(s=n._translateToSmw[l.nodeName])||!a(l)||t&&!P(s,t,n))i(l)||e.insertBefore(A(l),l.nextSibling),r=!0;else if(i(l))o&&l===e.firstChild&&"BR"===l.nodeName&&(r=!0);else{for(var d=l.querySelectorAll(l.nodeName),c=0;c<d.length;c++){var f=d[c];f.parentNode.insertBefore(A(f),f),x(f)}D(l,t,n,o&&l===e.firstChild)}else if(l.nodeType===re){var u=l.previousSibling;u&&u.nodeType===re&&(u.data+=l.data,x(l),l=u)}var h=l.nextSibling;r&&x(l),l=h}}function I(e,t,n){if(u(e))return f(t);if(h(e)){var o=q(t,n);return"containers"===o||"blockWithText"===o}var r=n._translateToSmw[W(e)];if(!r)if(g(e))r="hr";else{if(!m(e))return!1;r="smwWidget"}var i=n._translateToSmw[W(t)],a=i||t.nodeName.toLowerCase(),s=n._allowedBlocksForContainers[a];return s&&-1!==s.indexOf(r)}function P(e,t,n){var o=n._allowedInlineContentForBlocks[t];return o&&-1!==o.indexOf(e)}function W(e){var t;return e&&e.nodeType===oe?(t=e.getAttribute("class"))?e.nodeName+"."+t:e.nodeName:""}function F(e,t){if(e.isContentEditable){var n,o,r,i,s,l,d,c=e.childNodes,u=e.ownerDocument,h=z(u),p=h._config,g=q(e,h);for("blockWithText"!==g||f(e)||R(e,u,p),r=0,i=c.length;r<i;r+=1)if(s=c[r],!(l="BR"===s.nodeName)&&a(s))n||(n=L(u,p.blockTag,p.blockAttributes)),n.appendChild(s),r-=1,i-=1;else if(l||n)n||(n=L(u,p.blockTag,p.blockAttributes)),o=f(e)?L(u,"LI",[n]):n,l?e.replaceChild(o,s):(e.insertBefore(o,s),r+=1,i+=1),U(n,e,h,u),n=o=null;else if(d=q(s,h),I(s,e,h))switch("paragraph"!==d&&M(s,h,u,p)&&(r+=1,i+=1),d){case"containers":case"blockWithText":F(s,t);break;case"paragraph":U(s,e,h,u)}else"blockAtomic"===d||s.nodeType!==oe&&s.nodeType!==re||!/\S/.test(s.textContent)?(x(s),r-=1,i-=1):(n=L(u,p.blockTag,p.blockAttributes),o=f(e)?L(u,"LI",[n]):n,e.replaceChild(o,s),n.appendChild(s),U(n,e,h,u),n=o=null);return n&&(o=f(e)?L(u,"LI",[n]):n,e.appendChild(o),U(n,e,h,u)),"containers"===g&&h._ensureBottomLine(e),e}}function M(e,t,n,o){var r=q(e,t),i=!1;if("blockAtomic"===r||"containers"===r||d(e)||f(e))switch(q(e.previousSibling||e.parentNode,t)){case"blockAtomic":case"containers":var a=w(L(n,o.blockTag,o.blockAttributes),t._root);e.parentNode.insertBefore(a,e),i=!0}return i}function q(e,t){var n;if(e===t._root)n=t._inlineMode?"blockWithText":"containers";else if(h(e))n="paragraph";else if(u(e))n="blockWithText";else if(g(e)||m(e))n="blockAtomic";else{var o=W(e),r=t._translateToSmw[o];n=t._allowedContent[r]}return n}function H(e,t,n,o){var r,i,a,s=e.nodeType;if(s===re&&e!==n)return H(e.parentNode,e.splitText(t),n,o);if(s===oe){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(r=e.parentNode,i=e.cloneNode(!1);t;)a=t.nextSibling,i.appendChild(t),t=a;return"OL"===e.nodeName&&b(e,o,"BLOCKQUOTE")&&(i.start=(+e.start||1)+e.childNodes.length-1),w(e,o),w(i,o),(a=e.nextSibling)?r.insertBefore(i,a):r.appendChild(i),H(r,i,n,o)}return t}function K(e,t){if(e.nodeType===oe)for(var n,o,r,i=e.childNodes,s=i.length,l=[];s--;)if(n=i[s],o=s&&i[s-1],s&&a(n)&&N(n,o)&&!Ee[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=B(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=B(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=B(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=B(o))),x(n),n.nodeType===re?o.appendData(n.data):l.push(A(n));else if(n.nodeType===oe){for(r=l.length;r--;)n.appendChild(l.pop());K(n,t)}}function Q(e,t){if(e.nodeType===re&&(e=e.parentNode),e.nodeType===oe){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};K(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function G(e,t,n){for(var o,r,i,a=t;1===a.parentNode.childNodes.length;)a=a.parentNode;x(a),e.normalize(),r=e.childNodes.length,o=e.lastChild,o&&"BR"===o.nodeName&&(e.removeChild(o),r-=1),i={startContainer:e,startOffset:r,endContainer:e,endOffset:r},e.appendChild(A(t)),K(e,i),n.setStart(i.startContainer,i.startOffset),n.collapse(!0),ge&&(o=e.lastChild)&&"BR"===o.nodeName&&e.removeChild(o)}function j(e,t){var n,o,r=e.previousSibling,i=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if((!s||i&&/^[OU]L$/.test(i.nodeName))&&"H"!==e.nodeName[0])if(r&&N(r,e)){if(!l(r)){if(!s)return;o=L(a,"DIV"),o.appendChild(A(r)),r.appendChild(o)}x(e),n=!l(e),r.appendChild(A(e)),n&&F(r,t),i&&j(i,t)}else s&&(r=L(a,"DIV"),e.insertBefore(r,i),w(r,t))}function Z(e,t){e.saveUndoState(t),Re(t,e._root),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}function z(e){for(var t,n=lt.length;n--;)if(t=lt[n],t._doc===e)return t;return null}function V(e,t){var n,o;e||(e={});for(n in t)o=t[n],e[n]=o&&o.constructor===Object?V(e[n],o):o;return e}function $(e,t){e.nodeType===ie&&(e=e.body);var n,o=e.ownerDocument,r=o.defaultView;this._win=r,this._doc=o,this._root=e,this._events={},this._lastSelection=null,Ne&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent),this.addEventListener("undoStateChange",this._updateUndoState),this._undoIndex=-1,this._undoStack=[],this._undoScrollTopStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._canUndo=!1,this._canRedo=!1,Se?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",Y),this.addEventListener("input",X),this.addEventListener("mousedown",X),this.addEventListener("touchstart",X),this.addEventListener("focus",J),this._onSelectionChange=te.bind(this),o.addEventListener("selectionchange",this._onSelectionChange,!0),this._awaitingPaste=!1,this.addEventListener(pe?"beforecut":"cut",it),this.addEventListener("copy",at),this.addEventListener(pe?"beforepaste":"paste",st),this.addEventListener(ge?"keypress":"keydown",Ge),this._keyHandlers=Object.create(Ze),this._blockKeyEvents=!1,this.setConfig(t),this._allowedContent=Bt(t.classifications,t.allowedTags),this._classifications=t.classifications,this._allowedBlocks=t.allowedBlocksForContainers,this._allowedBlocksForContainers=t.allowedBlocksForContainers,this._allowedInlineContentForBlocks=t.allowedInlineContentForBlocks,this._translateToSmw=xt(t.tagAttributes,t.allowedTags),this._validTags=Object.keys(this._translateToSmw),this._onPasteErrorCallback=t.onPasteErrorCallback,this._onPasteCallback=t.onPasteCallback,this._inlineMode=t.inlineMode,this.confirmDeleteWidget=t.confirmDeleteWidget,pe&&(r.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,r=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),r&&this.deleteData(e,r),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}lt.push(this),this.setHTML(t.html||"",!1,!0)}function Y(){this._restoreSelection=!0}function X(){this._restoreSelection=!1}function J(){this._restoreSelection&&this.setSelection(this._lastSelection)}function ee(e,t,n){var o,r;for(o=t.firstChild;o;o=r){if(r=o.nextSibling,a(o)){if(o.nodeType===re||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([ee(e,o,e._doc.createDocumentFragment())]));continue}ee(e,o,n)}return n}function te(e){for(var t=this.getSelection(),n=t.commonAncestorContainer;n&&"BODY"!==n.nodeName&&!m(n);)n=n.parentNode;if(m(n))t.selectNode(n),this.setSelection(t);else if(t.startContainer&&t.collapsed&&!a(t.startContainer)&&!s(t.startContainer)){var o,r=t.startContainer.childNodes;o=r.length>0?r[Math.min(r.length-1,t.startOffset)]:t.startContainer;var i=_(o,this._root),l=!0;i||(i=C(o,this._root),l=!1),i&&(l?t.setStart(i,0):t.setStart(i,B(i)),t.collapse(!0),Ie(t),console.log("fixing selection",t),this.setSelection(t))}}function ne(e,t,o,r){if(t=t.toUpperCase(),o||(o={}),!r&&!(r=this.getSelection()))return[];!r.collapsed&&r.startContainer.nodeType===re&&r.startOffset===r.startContainer.length&&r.startContainer.nextSibling&&r.setStartBefore(r.startContainer.nextSibling),!r.collapsed&&r.endContainer.nodeType===re&&0===r.endOffset&&r.endContainer.previousSibling&&r.setEndAfter(r.endContainer.previousSibling);var i,a,s=r.commonAncestorContainer,l=[],d=b(s,e,t,o);if(d&&l.push(d),s.nodeType===re)return l;for(i=new n(s,se,function(e){return De(r,e,!0)});a=i.nextNode();)S(a,t,o)&&l.push(a);return l}var oe=1,re=3,ie=9,ae=11,se=1,le="​",de=e.defaultView,ce=navigator.userAgent,fe=/iP(?:ad|hone|od)/.test(ce),ue=/Mac OS X/.test(ce),he=/Gecko\//.test(ce),pe=/Trident\/[456]\./.test(ce),ge=!!de.opera,me=/Edge\//.test(ce),ve=!me&&/WebKit\//.test(ce),Ce=pe||ge,_e=pe||ve,Ne=pe,Se=!1,be=/[^ \t\r\n]/,Te=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var ye={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;){if((e=t.nextSibling)&&e.nodeType===oe&&"false"===e.getAttribute("contenteditable"))return this.currentNode=e,e;e||(t=t.parentNode)}if(!e)return null;if(ye[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){if(t===n)return null;if((e=t.previousSibling)&&e.nodeType===oe&&"false"===e.getAttribute("contenteditable"))return this.currentNode=e,e;if(e)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(ye[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(ye[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}};var ke=/^(?:#text|A|BR|B|I|STRONG|EM|INPUT)$/,Ee={BR:1,IMG:1,INPUT:1},Be=function(e,t){for(var n=e.childNodes;t&&e.nodeType===oe;)e=n[t-1],n=e.childNodes,t=n.length;return e},xe=function(e,t){if(e.nodeType===oe){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Oe=function(e){if(e.collapsed&&e.startContainer.nodeType===re)for(var t,n=e.startContainer.textContent,o=/\S+/g;null!==(t=o.exec(n));){var r=t.index,i=t.index+t[0].length;if(r<e.startOffset&&i>e.startOffset){e.setStart(e.startContainer,r),e.setEnd(e.startContainer,i);break}}return e},Ae=function(e,t){var n,o,r,i,a=e.startContainer,s=e.startOffset,l=e.endContainer,d=e.endOffset;a.nodeType===re?(n=a.parentNode,o=n.childNodes,s===a.length?(s=Te.call(o,a)+1,e.collapsed&&(l=n,d=s)):(s&&(i=a.splitText(s),l===a?(d-=s,l=i):l===n&&(d+=1),a=i),s=Te.call(o,a)),a=n):o=a.childNodes,r=o.length,s===r?a.appendChild(t):a.insertBefore(t,o[s]),a===l&&(d+=o.length-r),e.setStart(a,s),e.setEnd(l,d)},Le=function(e,n,o,r){var i=e.startContainer,a=e.startOffset,s=e.endContainer,l=e.endOffset;n||(n=e.commonAncestorContainer),n.nodeType===re&&(n=n.parentNode);var d,c,f,u=r!=t&&new RegExp(r).test(s.nodeName)?s:H(s,l,n,o),h=r!=t&&new RegExp(r).test(i.nodeName)?i:H(i,a,n,o),p=n.ownerDocument.createDocumentFragment();if(h===u&&r!=t&&new RegExp(r).test(h.nodeName))return p.appendChild(h),p;for(;h!==u;)d=h.nextSibling,p.appendChild(h),h=d;return i=n,a=u?Te.call(n.childNodes,u):n.childNodes.length,f=n.childNodes[a],c=f&&f.previousSibling,c&&c.nodeType===re&&f.nodeType===re&&(i=c,a=c.length,c.appendData(f.data),x(f)),e.setStart(i,a),e.collapse(!0),w(n,o),p},we=function(e,t){for(var n=e.startContainer,o=e.endContainer;n&&n!==t;)n.nodeType===re||n.isContentEditable||e.setStartBefore(n),n=n.parentNode;for(;o&&o!==t;)o.nodeType===re||o.isContentEditable||e.setEndAfter(o),o=o.parentNode},Re=function(e,t){we(e,t),Pe(e);var n=e.startContainer,o=e.endContainer,r=(a(n)||s(n))&&(a(o)||s(o)),i=Le(e,null,t);Ie(e),n=We(e,t),r&&(o=Fe(e,t),n&&o&&n!==o&&G(n,o,e)),n&&w(n,t);var l=t.firstChild;return l&&"BR"!==l.nodeName?e.collapse(!1):(w(t,t),e.selectNodeContents(t.firstChild)),i},Ue=function(e,t,n){for(var o=!0,r=t.childNodes,i=r.length;i--;)if(!a(r[i])){o=!1;break}if(e.collapsed||Re(e,n),Ie(e),o)Ae(e,t),e.collapse(!1);else{for(var d,c,f,u,h,p=e.startContainer,g=H(p,e.startOffset,b(p.parentNode,n,"BLOCKQUOTE")||n,n),m=g.previousSibling,v=m,N=v.childNodes.length,S=g,T=0,y=g.parentNode;(d=v.lastChild)&&d.nodeType===oe;){if("BR"===d.nodeName){N-=1;break}v=d,N=v.childNodes.length}for(;(d=S.firstChild)&&d.nodeType===oe&&"BR"!==d.nodeName;)S=d;for(h=v.childNodes[N]||null;(d=t.firstChild)&&a(d);)v.insertBefore(d,h);for(;(d=t.lastChild)&&a(d);)S.insertBefore(d,S.firstChild),T+=1;if(c=t,y.insertBefore(t,g),u=m.nextSibling,(c=C(u,n))&&!/\S/.test(c.textContent))do{y=c.parentNode,y.removeChild(c),c=y}while(c&&!c.lastChild&&c!==n);if(m.parentNode||(m=u.previousSibling),v.parentNode||(v=m||u.parentNode,N=m?m.childNodes.length:0),l(u)&&u.isContentEditable&&j(u,n),f=g.previousSibling,(c=s(g)?g:_(g,n))&&!/\S/.test(c.textContent))do{y=c.parentNode,y.removeChild(c),c=y}while(c&&!c.lastChild&&c!==n);g.parentNode||(g=f.nextSibling),T||(S=f,T=f.childNodes.length),g&&l(g)&&g.isContentEditable&&j(g,n),e.setStart(v,N),e.setEnd(S,T),we(e,n),Ie(e)}},De=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var r=e.compareBoundaryPoints(3,o)>-1,i=e.compareBoundaryPoints(1,o)<1;return!r&&!i}var a=e.compareBoundaryPoints(0,o)<1,s=e.compareBoundaryPoints(2,o)>-1;return a&&s},Ie=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset;n.nodeType!==re&&(t=n.childNodes[o])&&!i(t)&&t.isContentEditable;)n=t,o=0;if(a)for(;r.nodeType!==re&&(t=r.childNodes[a-1])&&!i(t)&&t.isContentEditable;)r=t,a=B(r);else for(;r.nodeType!==re&&(t=r.firstChild)&&!i(t)&&t.isContentEditable;)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Pe=function(e,t){var n,o=e.startContainer,r=e.startOffset,i=e.endContainer,a=e.endOffset;for(t||(t=e.commonAncestorContainer);o!==t&&!r;)n=o.parentNode,r=Te.call(n.childNodes,o),o=n;for(;i!==t&&a===B(i);)n=i.parentNode,a=Te.call(n.childNodes,i)+1,i=n;e.setStart(o,r),e.setEnd(i,a)},We=function(e,t){var n,o=e.startContainer;return a(o)?n=C(o,t):s(o)?n=o:(n=Be(o,e.startOffset),n=_(n,t)),n&&De(e,n,!0)?n:null},Fe=function(e,t){var n,o,r=e.endContainer;if(a(r))n=C(r,t);else if(s(r))n=r;else{if(!(n=xe(r,e.endOffset)))for(n=t;o=n.lastChild;)n=o;n=C(n,t)}return n&&De(e,n,!0)?n:null},Me=new n(null,4|se,function(e){return e.nodeType===re?be.test(e.data):"IMG"===e.nodeName}),qe=function(e,t){var n=e.startContainer,o=e.startOffset;if(Me.root=null,n.nodeType===re){if(o)return!1;Me.currentNode=n}else Me.currentNode=xe(n,o);return Me.root=We(e,t),!Me.previousNode()},He=function(e,t){var n,o=e.endContainer,r=e.endOffset;if(Me.root=null,o.nodeType===re){if((n=o.data.length)&&r<n)return!1;Me.currentNode=o}else Me.currentNode=Be(o,r);return Me.root=Fe(e,t),!Me.nextNode()},Ke=function(e,t){for(var n,o,r,i=e.commonAncestorContainer,a=null;i&&i!==t;)"false"!==i.getAttribute("contenteditable")&&i.isContentEditable||(a=i),i=i.parentNode;a?(n=a,o=a):(n=We(e,t),o=Fe(e,t)),n&&o&&(r=n.parentNode,e.setStart(r,Te.call(r.childNodes,n)),r=o.parentNode,e.setEnd(r,Te.call(r.childNodes,o)+1))},Qe={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},Ge=function(e){var t=e.keyCode,n=Qe[t],o="",i=this.getSelection();if(!e.defaultPrevented){if(this._blockKeyEvents)return void e.preventDefault();if(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),ge&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-"),e.shiftKey&&(o+="shift-")),n=o+n,-1===this._undoIndex&&this.saveUndoState(i),this._keyHandlers[n])this._keyHandlers[n](this,e,i);else if(1===n.length&&!i.collapsed)if(i.commonAncestorContainer&&T(i.commonAncestorContainer,this._root,m))e.preventDefault();else{var a=r(i,function(e){return m(e)}),s=this;a?(e.preventDefault(),this._blockKeyEvents=!0,this.confirmDeleteWidget(a.getAttribute("widget-id"),a.getAttribute("widget-type")).then(function(){Z(s,i)}).finally(function(){s._blockKeyEvents=!1,s.focus()})):Z(s,i)}}},je=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===re&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===le);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,Te.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=C(n,e._root)),w(n,e._root),Ie(t)),s(n)&&(n.nodeName!==e._config.blockTag?(F(e._root,e._root),Ie(t)):Q(n,t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&x(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},Ze={"shift-enter":function(e,t,n){Ft(e,n)||t.preventDefault()},enter:function(e,t,n){var o=e._root;t.preventDefault(),e._recordUndoState(n),kt(n.startContainer),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||Re(n,o),F(o,o);var r=We(n,o);if(!r)return n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);var i,a,s,l=r.parentNode;if(l===o||c(l)?(i=l,l=r):i=l.parentNode,e._inlineMode){var f=L(e._doc,"br");Ae(n,f),n.setStartAfter(f),n.setEndAfter(f)}else{var h=b(n.startContainer,o,"A");for(p(l)?r.textContent.trim()?0===n.startOffset?(i.insertBefore(e.createDefaultBlock(),l),a=r):a=gt(e,l,n):(i.insertBefore(e.createDefaultBlock(),l),x(l),a=pt(e,r,n.startContainer,n.startOffset)):d(l)?a=gt(e,l,n):u(l)?i.lastElementChild!==l||r.textContent.trim()?(s=pt(e,l,n.startContainer,n.startOffset),a=s.firstElementChild):(e.modifyBlocks(Tt,n),a=r):a=pt(e,r,n.startContainer,n.startOffset),ut(r),tt(r),w(r,o);a.nodeType===oe;){var g,m=a.firstChild;if("A"===a.nodeName){var v=a.textContent;if(v===le&&(v=""),!v||h&&h.textContent&&h.href===a.href){m=e._doc.createTextNode(v),O(a,m),a=m;break}h&&!h.textContent&&(x(h),h=null)}for(;m&&m.nodeType===re&&!m.data;)g=m.nextSibling,x(m),m=g;if(m&&"BR"===m.nodeName&&(g=m.nextSibling,x(m),m=g),!m||m.nodeType===re&&!ge)break;a=m}}a&&(n=e._createRange(a,0)),F(o,o),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed){var r=n.startContainer;if(r.nodeType===oe&&r.firstChild&&!a(r)&&(n.startOffset>=r.childNodes.length?r.lastChild.nodeType===oe?(n.setStart(r.lastChild,r.lastChild.childNodes.length),n.setEnd(r.lastChild,r.lastChild.childNodes.length)):(n.setStart(r.lastChild,r.lastChild.data.length),n.setEnd(r.lastChild,r.lastChild.data.length)):Ie(n)),qe(n,o)){t.preventDefault();var i,s=We(n,o);if(!s)return;F(s.parentNode,o),i=C(s,o);var l,f=s.parentNode;if(f===o||c(f)?(l=f,f=s):l=f.parentNode,d(f))e.modifyBlocks(vt,n);else if(l.firstElementChild===f||c(f.previousElementSibling))u(f)&&e.modifyBlocks(Tt,n);else if(i){var v;v=i.parentNode===o||c(i.parentNode)?i:i.parentNode,m(v)?(e._blockKeyEvents=!0,e.confirmDeleteWidget(v.getAttribute("widget-id"),v.getAttribute("widget-type")).then(function(){x(v)}).finally(function(){e._blockKeyEvents=!1,e.focus()})):g(v)||(h(v)||p(v))&&!i.textContent.trim()||!v.isContentEditable?x(v):G(i,s,n)}F(o,o),e.setSelection(n),e._updatePath(n,!0)}else e.setSelection(n),setTimeout(function(){je(e)},0)}else t.preventDefault(),Re(n,o),je(e,n)},delete:function(e,t,n){var o,r,i,a,s,l,d=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(He(n,d)){if(t.preventDefault(),!(o=We(n,d)))return;F(o.parentNode,d),r=_(o,d);var u,p;if(o.parentNode===d||c(o.parentNode)?(u=o,p=o.parentNode):(u=o.parentNode,p=u.parentNode),c(u.nextElementSibling)||p.lastElementChild===u&&(!f(p)||c(p.nextElementSibling)));else if(r){var v;v=r.parentNode===d||c(r.parentNode)?r:r.parentNode,m(v)?(e._blockKeyEvents=!0,e.confirmDeleteWidget(v.getAttribute("widget-id"),v.getAttribute("widget-type")).then(function(){x(v)}).finally(function(){e._blockKeyEvents=!1,e.focus()})):g(v)||!v.isContentEditable?x(v):h(u)&&!o.textContent.trim()?(x(u),n.setStart(r,0),Ie(n)):G(o,r,n),F(d,d),e.setSelection(n),e._updatePath(n,!0)}}else{if(i=n.cloneRange(),Pe(n,e._root),a=n.endContainer,s=n.endOffset,a.nodeType===oe&&(l=a.childNodes[s])&&"IMG"===l.nodeName)return t.preventDefault(),x(l),Ie(n),void je(e,n);e.setSelection(i),setTimeout(function(){je(e)},0)}else t.preventDefault(),Re(n,d),je(e,n)},space:function(e,t,n){var o,r;e._recordUndoState(n),kt(n.startContainer),e._getRangeAndRemoveBookmark(n),o=n.endContainer,r=o.parentNode,n.collapsed&&"A"===r.nodeName&&!o.nextSibling&&n.endOffset===B(o)&&n.setStartAfter(r),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};ue&&he&&(Ze["meta-left"]=function(e,t){t.preventDefault();var n=ft(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Ze["meta-right"]=function(e,t){t.preventDefault();var n=ft(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),ue||(Ze.pageup=function(e){e.moveCursorToStart()},Ze.pagedown=function(e){e.moveCursorToEnd()});var ze=function(e){return function(t,n){var o=L(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(A(t)),o}},Ve={SPAN:function(t,n){var o=e.createTextNode(t.textContent);return n.replaceChild(o,t),o},STRONG:ze("B"),EM:ze("I"),IMG:function(n,o,r){if("page-break"===n.className)return n;var i=L(e,"P",{class:"smw-missing-image"}),a=[n.src,n.alt,n.title].filter(function(e){return e!==t||""!==e});return i.innerHTML="<br><b>Missing image: "+a.join("<br>")+"</b><br>",o.replaceChild(i,n),r&&r(n),i},A:function(e,t){return e},LI:function(t,n){var o;if("P"!==t.firstChild.nodeName){var r=L(e,"P",{},[e.createTextNode(t.textContent)]);o=L(e,"LI",{},[r]),n.replaceChild(o,t)}else o=t;return o},BLOCKQUOTE:function(e){return"aside"!==e.className&&(e.className="blockquote"),e}},$e=/^(A|BLOCKQUOTE|H[1-4]|LI|UL|OL|P|ASIDE|MYWO-CONTENT-WIDGET|SMW-CONTENT-WIDGET|DIV|BR)$/,Ye=/^(MYWO-CONTENT-WIDGET)$/,Xe=/^(?:HEAD|META|STYLE)/,Je=new n(null,4|se,function(){return!0}),et=function n(o,r,i){var s,l,d,c,f,u,h,p,g,m,v,C,_=o.childNodes;for(s=o;a(s);)s=s.parentNode;for(Je.root=s,l=0,d=_.length;l<d;l+=1)if(c=_[l],f=c.nodeName,u=c.nodeType,h=Ve[f],u===oe){if(c.setAttribute("style",""),p=c.childNodes.length,h){var N=h(c,o,i);if(!N){l-=1,d-=1,o.removeChild(c);continue}c=N,c.nodeType===re&&(p=t)}else{if(Xe.test(f)){o.removeChild(c),l-=1,d-=1;continue}if(!$e.test(f)&&!a(c)){var S=c.textContent||c.innerText;o.replaceChild(e.createTextNode(S),c),i&&i(c);continue}}p&&!Ye.test(f)&&n(c,r||"PRE"===f,i)}else{if(u===re){if(v=c.data,g=!be.test(v.charAt(0)),m=!be.test(v.charAt(v.length-1)),r||!g&&!m)continue;if(g){for(Je.currentNode=c;(C=Je.previousPONode())&&!("IMG"===(f=C.nodeName)||"#text"===f&&/\S/.test(C.data));)if(!a(C)){C=null;break}v=v.replace(/^\s+/g,C?" ":"")}if(m){for(Je.currentNode=c;(C=Je.nextNode())&&!("IMG"===f||"#text"===f&&/\S/.test(C.data));)if(!a(C)){C=null;break}v=v.replace(/\s+$/g,C?" ":"")}if(v){c.data=v;continue}}o.removeChild(c),l-=1,d-=1}return o},tt=function e(t){for(var n,o=t.childNodes,r=o.length;r--;)n=o[r],n.nodeType!==oe||i(n)?n.nodeType!==re||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},nt=function(e){return e.nodeType===oe?"BR"===e.nodeName:be.test(e.data)},ot=function(e){for(var t,o=e.parentNode;a(o);)o=o.parentNode;return t=new n(o,4|se,nt),t.currentNode=e,!!t.nextNode()},rt=function(e,t){var n,o,r,i=e.querySelectorAll("BR"),s=[],l=i.length;for(n=0;n<l;n+=1)s[n]=ot(i[n]);for(;l--;)o=i[l],(r=o.parentNode)&&(s[l]?a(r):x(o))},it=function(e){var t=e.clipboardData,n=this.getSelection(),o=this.createElement("div"),r=this._root,i=this;this.saveUndoState(n),!fe&&t?(Pe(n,r),o.appendChild(Re(n,r)),t.setData("text/html",o.innerHTML),t.setData("text/plain",o.innerText||o.textContent),e.preventDefault(),F(r,r)):setTimeout(function(){try{F(r,r)}catch(e){i.didError(e)}},0),this._docWasChanged(),this.setSelection(n)},at=function(e){var t=e.clipboardData,n=this.getSelection(),o=this.createElement("div");!fe&&t&&(o.appendChild(n.cloneContents()),t.setData("text/html",o.innerHTML),t.setData("text/plain",o.innerText||o.textContent),e.preventDefault())},st=function(e){var t,n,o,r,i,a=e.clipboardData,s=a&&a.items,l=!1,d=!1,c=null,f=this;if(s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],"text/html"===(o=n.type))return void n.getAsString(function(e){f.insertHTML(e,!0)});"text/plain"===o&&(c=n),/^image\/.*/.test(o)&&(d=!0)}return void(d?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):c&&c.getAsString(function(e){f.insertPlainText(e,!0)}))}if((r=a&&a.types)&&(Te.call(r,"text/html")>-1||!he&&Te.call(r,"text/plain")>-1&&Te.call(r,"text/rtf")<0))return e.preventDefault(),void((i=a.getData("text/html"))?this.insertHTML(i,!0):((i=a.getData("text/plain"))||(i=a.getData("text/uri-list")))&&this.insertPlainText(i,!0));this._awaitingPaste=!0;var u=this._doc.body,h=this.getSelection(),p=h.startContainer,g=h.startOffset,m=h.endContainer,v=h.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});u.appendChild(C),h.selectNodeContents(C),this.setSelection(h),setTimeout(function(){try{f._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,x(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=f._createRange(p,g,m,v),f.setSelection(t),n&&f.insertHTML(n,!0)}catch(e){f.didError(e)}},0)},lt=[],dt=$.prototype;dt.setConfig=function(e){return e=V({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null}},e),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},dt.createElement=function(e,t,n){return L(this._doc,e,t,n)},dt.createDefaultBlock=function(e,t){var n=this._config;return w(this.createElement(n.blockTag,n.blockAttributes,e),this._root)},dt.didError=function(e){console.error(e)},dt.getDocument=function(){return this._doc},dt.getRoot=function(){return this._root};var ct={pathChange:1,select:1,input:1,undoStateChange:1,dragover:1,drop:1};dt.fireEvent=function(e,t){var n,o,r=this._events[e];if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),n=r.length;n--;){o=r[n];try{o.handleEvent?o.handleEvent(t):o.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},dt.destroy=function(){var e,t=this._root,n=this._events;for(e in n)ct[e]||t.removeEventListener(e,this,!0);this._mutation&&this._mutation.disconnect(),this._doc.removeEventListener("selectionchange",this._onSelectionChange,!0);for(var o=lt.length;o--;)lt[o]===this&&lt.splice(o,1);this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},dt.handleEvent=function(e){this.fireEvent(e.type,e)},dt.addEventListener=function(e,t){var n=this._events[e];return t?(n||(n=this._events[e]=[],ct[e]||this._root.addEventListener(e,this,!0)),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},dt.removeEventListener=function(e,t){var n,o=this._events[e];if(o){for(n=o.length;n--;)o[n]===t&&o.splice(n,1);o.length||(delete this._events[e],ct[e]||this._root.removeEventListener(e,this,!0))}return this},dt._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var r=this._doc.createRange();return r.setStart(e,t),n?r.setEnd(n,o):r.setEnd(e,t),r},dt.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect()
;return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=le,Ae(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),K(n,{startContainer:e.startContainer,endContainer:e.endContainer,startOffset:e.startOffset,endOffset:e.endOffset})),o},dt._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Ie(n),this.setSelection(n),this},dt.moveCursorToStart=function(){return this._moveCursorTo(!0)},dt.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var ft=function(e){return e._win.getSelection()||null};dt.setSelection=function(e){if(e){this._restoreSelection=!1,this._lastSelection=e,fe&&this._win.focus();var t=ft(this);t&&(t.removeAllRanges(),t.addRange(e))}return this},dt.getSelection=function(){var e,t,n,o=ft(this),r=this._root;return o&&o.rangeCount&&(e=o.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&k(r,e.commonAncestorContainer)?this._lastSelection=e:e=this._lastSelection,e||(e=this._createRange(r.firstChild,0)),e},dt.getSelectedText=function(){var e,t=this.getSelection(),o=new n(t.commonAncestorContainer,4|se,function(e){return De(t,e,!0)}),r=t.startContainer,i=t.endContainer,s=o.currentNode=r,l="",d=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===re?(e=s.data)&&/\S/.test(e)&&(s===i&&(e=e.slice(0,t.endOffset)),s===r&&(e=e.slice(t.startOffset)),l+=e,d=!0):"BR"===s.nodeName||d&&!a(s)?(l+="\n",d=!1):("HR"===s.nodeName||d&&!a(s))&&(l+="\n\n\n",d=!1),s=o.nextNode();return l},dt.getPath=function(){return this._path};var ut=function(e){for(var t,o,r,i=new n(e,4,function(){return!0},!1);o=i.nextNode();)if(o.data)for(;(r=o.data.indexOf(le))>-1;){if(1===o.length){do{t=o.parentNode,t.removeChild(o),o=t,i.currentNode=t}while(a(o)&&!B(o));break}o.deleteData(r,1)}};dt._didAddZWS=function(){this._hasZWS=!0},dt._removeZWS=function(){this._hasZWS&&(ut(this._root),this._hasZWS=!1)},dt._updatePath=function(e,t){if(e){var n,o=e.startContainer,r=e.endContainer;(t||o!==this._lastAnchorNode||r!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=r,n=o&&r?o===r?E(r,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),e.collapsed||this.fireEvent("select")}},dt._updatePathOnEvent=function(){this._updatePath(this.getSelection())},dt._updateUndoState=function(e){this._canUndo=e.canUndo,this._canRedo=e.canRedo},dt.focus=function(){return this._root.focus(),this},dt.blur=function(){return this._root.blur(),this};dt._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),o=this.createElement("INPUT",{id:"squire-selection-end",type:"hidden"});Ae(e,n),e.collapse(!1),Ae(e,o),2&n.compareDocumentPosition(o)&&(n.id="squire-selection-end",o.id="squire-selection-start",t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},dt._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),o=t.querySelector("#squire-selection-end");if(n&&o){var r=n.parentNode,i=o.parentNode,a={startContainer:r,endContainer:i,startOffset:Te.call(r.childNodes,n),endOffset:Te.call(i.childNodes,o)};r===i&&(a.endOffset-=1),x(n),x(o),e||(e=this._doc.createRange()),e.setStart(a.startContainer,a.startOffset),e.setEnd(a.endContainer,a.endOffset),Q(r,e),r!==i&&Q(i,e),e.collapsed&&(r=e.startContainer,r.nodeType===re&&(i=r.childNodes[e.startOffset],i&&i.nodeType===re||(i=r.childNodes[e.startOffset-1]),i&&i.nodeType===re&&(e.setStart(i,0),e.collapse(!0))))}return e||null},dt._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},dt._docWasChanged=function(){if(Se&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),-1===this._undoIndex&&this.saveUndoState(),this.fireEvent("input")},dt._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n=this._undoIndex+=1,o=this._undoStack,r=this._undoScrollTopStack;n<this._undoStackLength&&(o.length=this._undoStackLength=n,r.length=this._undoStackLength=n),F(this._root,this._root),e&&this._saveRangeToBookmark(e),o[n]=this._getHTML(),r[n]=0===n?null:this._doc.documentElement.scrollTop||this._doc.body.scrollTop,this._undoStackLength+=1,this._isInUndoState=!0}},dt.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e)),this},dt.undo=function(){if(this._undoIndex>0||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1;var e=this._undoScrollTopStack[this._undoIndex];null===e&&(e=this._doc.documentElement.scrollTop||this._doc.body.scrollTop),this._setHTML(this._undoStack[this._undoIndex]);var t=this._getRangeAndRemoveBookmark();t&&this.setSelection(t),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:this._undoIndex>0,canRedo:!0}),this.fireEvent("input"),this._doc.documentElement.scrollTop=e,this._doc.body.scrollTop=e;var n=this;setTimeout(function(){n._doc&&n._doc.documentElement&&(n._doc.documentElement.scrollTop=e,n._doc.body.scrollTop=e)},16)}return this.focus()},dt.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1;var n=this._undoScrollTopStack[this._undoIndex];this._setHTML(this._undoStack[this._undoIndex]);var o=this._getRangeAndRemoveBookmark();o&&this.setSelection(o),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input"),this._doc.documentElement.scrollTop=n,this._doc.body.scrollTop=n;var r=this;setTimeout(function(){r._doc&&r._doc.documentElement&&(r._doc.documentElement.scrollTop=n,r._doc.body.scrollTop=n)},16)}return this.focus()},dt.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===re&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===re&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var r,i,a=this._root,s=o.commonAncestorContainer;if(b(s,a,e,t))return!0;if(s.nodeType===re)return!1;r=new n(s,4,function(e){return De(o,e,!0)},!1);for(var l=!1;i=r.nextNode();){if(!b(i,a,e,t))return!1;l=!0}return l},dt.getFontInfo=function(e){var n,o,r,i={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return i;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===re)for(n.nodeType===re&&(n=n.parentNode);a<4&&n;)(o=n.style)&&(!i.color&&(r=o.color)&&(i.color=r,a+=1),!i.backgroundColor&&(r=o.backgroundColor)&&(i.backgroundColor=r,a+=1),!i.family&&(r=o.fontFamily)&&(i.family=r,a+=1),!i.size&&(r=o.fontSize)&&(i.size=r,a+=1)),n=n.parentNode;return i},dt._addFormat=function(e,t,o){var r,i,a,s,l,d,c,f=this._root;if(o.collapsed)r=w(this.createElement(e,t),f),Ae(o,r),o.setStart(r.firstChild,r.firstChild.length),o.collapse(!0);else{if(i=new n(o.commonAncestorContainer,4|se,function(e){return(e.nodeType===re||"BR"===e.nodeName||"IMG"===e.nodeName)&&De(o,e,!0)},!1),a=o.startContainer,l=o.startOffset,s=o.endContainer,d=o.endOffset,i.currentNode=a,i.filter(a)||(a=i.nextNode(),l=0),!a)return o;do{c=i.currentNode,!b(c,f,e,t)&&(c===s&&c.length>d&&c.splitText(d),c===a&&l&&(c=c.splitText(l),s===a&&(s=c,d-=l),a=c,l=0),r=this.createElement(e,t),O(c,r),r.appendChild(c))}while(i.nextNode());s.nodeType!==re&&(c.nodeType===re?(s=c,d=c.length):(s=c.parentNode,d=1)),o=this._createRange(a,l,s,d)}return o},dt._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var r,i=this._doc;n.collapsed&&(_e?(r=i.createTextNode(le),this._didAddZWS()):r=i.createTextNode(""),Ae(n,r));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var l=n.startContainer,d=n.startOffset,c=n.endContainer,f=n.endOffset,u=[],h=function(e,t){if(!De(n,e,!1)){var o,r,i=e.nodeType===re;if(!De(n,e,!0))return void("INPUT"===e.nodeName||i&&!e.data||u.push([t,e]));if(i)e===c&&f!==e.length&&u.push([t,e.splitText(f)]),e===l&&d&&(e.splitText(d),u.push([t,e]));else for(o=e.firstChild;o;o=r)r=o.nextSibling,h(o,t)}},p=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return De(n,o,!0)&&S(o,e,t)});o||p.forEach(function(e){h(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];O(n,t),t.appendChild(n)}),p.forEach(function(e){O(e,A(e))}),this._getRangeAndRemoveBookmark(n),r&&n.collapse(!1);var g={startContainer:n.startContainer,startOffset:n.startOffset,endContainer:n.endContainer,endOffset:n.endOffset};return K(s,g),n.setStart(g.startContainer,g.startOffset),n.setEnd(g.endContainer,g.endOffset),n},dt.changeFormat=function(e,t,n,o){if(n||(n=this.getSelection()))return this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),Se||this._docWasChanged(),this};var ht={DT:"DD",DD:"DT",LI:"LI"},pt=function(e,t,n,o){var r=ht[t.nodeName],i=null,a=H(n,o,t.parentNode,e._root),s=e._config;return r||(r=s.blockTag,i=s.blockAttributes),S(a,r,i)||(t=L(a.ownerDocument,r,i),a.dir&&(t.dir=a.dir),O(a,t),t.appendChild(A(a)),a=t),a},gt=function(e,t,n){var o=pt(e,t,n.startContainer,n.startOffset),r=o.firstElementChild,i=t.parentNode;return i.insertBefore(r,o),i.removeChild(o),r};dt.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,r=We(n,o),i=Fe(n,o);if(r&&i)do{if(e(r)||r===i)break}while(r=_(r,o));return t&&(this.setSelection(n),this._updatePath(n,!0),Se||this._docWasChanged()),this},dt.modifyBlocks=function(e,t,n,o,r,i){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(i||t):this._recordUndoState(i||t);var a,s,l,d=this._root;return n&&(l=y(t.commonAncestorContainer,n,o)),l?(t.setStart(l,0),t.setEnd(l,l.childNodes.length)):Ke(t,d),s=r?d:b(t.commonAncestorContainer,d,"BLOCKQUOTE",{class:"aside"})||d,Pe(t,s),a=Le(t,s,d),Ae(t,e.call(this,a)),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),Se||this._docWasChanged(),this};var mt=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},vt=function(e){var t=e.querySelectorAll("blockquote"),n=t[t.length-1];return O(n,A(n)),e},Ct=function(e,n,o,r){for(var i,a,s,l,d=r!=t?r:o.toLowerCase(),c=v(n,e._root),f=e._config.tagAttributes,u=f[d]||{class:""},h=f.li;i=c.nextNode();)a=i.parentNode.nodeName,"LI"!==a?(l=e.createElement("LI",h),i.dir&&(l.dir=i.dir),(s=i.previousSibling)&&s.nodeName===o?s.appendChild(l):O(i,e.createElement(o,u,[l])),l.appendChild(i)):(i=i.parentNode.parentNode,(a=i.nodeName)===o&&i.getAttribute("class")===u.class||!/^[OU]L$/.test(a)||O(i,e.createElement(o,u,[A(i)])))},_t=function(e){return Ct(this,e,"UL"),e},Nt=function(e){return Ct(this,e,"OL"),e},St=function(e){var t,n,o,r,i,a,s,l=e.querySelectorAll("UL, OL");for(t=0,n=l.length;t<n;t+=1){for(r=l[t],i=A(r),a=i.childNodes,o=a.length;o--;)s=a[o],O(s,A(s));F(i,this._root),O(r,i)}return e},bt=function(e){var t,n,o,r,i,a,s=e.querySelectorAll("LI"),d=this._config.tagAttributes,c=d.li;for(t=0,n=s.length;t<n;t+=1)o=s[t],l(o.firstChild)||(r=o.parentNode.nodeName,i=o.previousSibling,i&&(i=i.lastChild)&&i.nodeName===r||(a=d[r.toLowerCase()],O(o,this.createElement("LI",c,[i=this.createElement(r,a)]))),i.appendChild(o));return e},Tt=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!l(e.firstChild)}).forEach(function(n){var o,r=n.parentNode,i=r.parentNode,a=n.firstChild,s=a;for(n.previousSibling&&(r=H(r,n,i,t));s&&(o=s.nextSibling,!l(s));)i.insertBefore(s,r),s=o;for("LI"===i.nodeName&&a.previousSibling&&H(i,a,i.parentNode,t);n!==e&&!n.childNodes.length;)r=n.parentNode,r.removeChild(n),n=r},this),F(e,t),e};dt._ensureBottomLine=function(e){var n=e===t?this._root:e,o=n.lastElementChild;o&&o.nodeName===this._config.blockTag&&s(o)||n.appendChild(this.createDefaultBlock())},dt.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},dt._getHTML=function(){return this._root.innerHTML},dt._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{w(n,t)}while(n=_(n,t));this._ignoreChange=!0},dt.getHTML=function(e){var t,n,o,r,i,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),Ce)for(t=this._root,n=t;n=_(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(r=this._getHTML().replace(/\u200B/g,""),Ce)for(i=s.length;i--;)x(s[i]);return a&&this._getRangeAndRemoveBookmark(a),r},dt.setHTML=function(e,t,n){var o,r=this._doc.createDocumentFragment(),i=this.createElement("DIV"),a=this._root;for(i.innerHTML=e,r.appendChild(A(i)),n||(et(r),rt(r)),this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);if(a.appendChild(r),F(a,a),!t){this._undoIndex=-1,this._undoStack.length=0,this._undoScrollTopStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var s=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);this._lastSelection=s,this._updatePath(s,!0)}return this},dt.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))Ae(t,e),t.setStartAfter(e);else{for(var n,o,r=this._root,i=We(t,r)||r;i!==r&&!i.nextSibling;)i=i.parentNode;i!==r&&(n=i.parentNode,o=H(n,i.nextSibling,r,r)),o?r.insertBefore(e,o):(r.appendChild(e),o=this.createDefaultBlock(),r.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Ie(t)}return this.focus(),this.setSelection(t),this._updatePath(t),this},dt.insertImage=function(e,t){var n=this,o=n.getSelection();n._recordUndoState(o),n._getRangeAndRemoveBookmark(o);var r=this.createElement("IMG",V({src:e},t));this.insertElement(r),n._docWasChanged();var i=n._doc.createRange();return i.selectNode(r),i.collapse(!1),n._recordUndoState(i),n._getRangeAndRemoveBookmark(i),r};var yt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,kt=function(e,t){for(var o,r,i,a,s,l,d,c=e.ownerDocument,f=new n(e,4,function(e){return!b(e,t,"A")},!1);o=f.nextNode();)for(r=o.data,i=o.parentNode;a=yt.exec(r);)s=a.index,l=s+a[0].length,s&&(d=c.createTextNode(r.slice(0,s)),i.insertBefore(d,o)),d=c.createElement("A"),d.textContent=r.slice(s,l),d.href=a[1]?/^(?:ht|f)tps?:/.test(a[1])?a[1]:"http://"+a[1]:"mailto:"+a[2],i.insertBefore(d,o),o.data=r=r.slice(l)};dt.insertHTML=function(e,t){var n=this.getSelection(),o=this._doc.createDocumentFragment(),r=this.createElement("DIV");r.innerHTML=e,o.appendChild(A(r)),this.saveUndoState(n);try{var i=this._root,a=o,s={fragment:o,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1};kt(o,i);var l=t?this._onPasteErrorCallback:null;for(et(o,!1,l),rt(o),tt(o),o.normalize();a=_(a,i);)w(a,i);t&&this.fireEvent("willPaste",s),s.defaultPrevented||(Ue(n,s.fragment,i),Se||this._docWasChanged(),n.collapse(!1),F(i,i),t&&this._onPasteCallback&&this._onPasteCallback()),this.setSelection(n),this._updatePath(n,!0)}catch(e){this.didError(e)}return this},dt.insertPlainText=function(e,t){var n,o,r,i=e.split("\n");for(n=0,o=i.length;n<o;n+=1)r=i[n],r=r.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").replace(/ (?= )/g,"&nbsp;"),n&&n+1<o&&(r="<DIV>"+(r||"<BR>")+"</DIV>"),i[n]=r;return this.insertHTML(i.join(""),t)};var Et=function(e,t,n){return function(){return this[e](t,n),this.focus()}};dt.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},dt.underline=Et("changeFormat",{tag:"U"}),dt.strikethrough=Et("changeFormat",{tag:"S"}),dt.subscript=Et("changeFormat",{tag:"SUB"},{tag:"SUP"}),dt.superscript=Et("changeFormat",{tag:"SUP"},{tag:"SUB"}),dt.removeUnderline=Et("changeFormat",null,{tag:"U"}),dt.removeStrikethrough=Et("changeFormat",null,{tag:"S"}),dt.removeSubscript=Et("changeFormat",null,{tag:"SUB"}),dt.removeSuperscript=Et("changeFormat",null,{tag:"SUP"}),dt.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;Ae(n,this._doc.createTextNode(e.slice(o)))}return t||(t={}),t.href=e,this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},dt.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},dt.setFontFace=function(e){return this.changeFormat({tag:"SPAN",attributes:{class:"font",style:"font-family: "+e+", sans-serif;"}},{tag:"SPAN",attributes:{class:"font"}}),this.focus()},dt.setFontSize=function(e){return this.changeFormat({tag:"SPAN",attributes:{class:"size",style:"font-size: "+("number"==typeof e?e+"px":e)}},{tag:"SPAN",attributes:{class:"size"}}),this.focus()},dt.setTextColour=function(e){return this.changeFormat({tag:"SPAN",attributes:{class:"colour",style:"color:"+e}},{tag:"SPAN",attributes:{class:"colour"}}),this.focus()},dt.setHighlightColour=function(e){return this.changeFormat({tag:"SPAN",attributes:{class:"highlight",style:"background-color:"+e}},{tag:"SPAN",attributes:{class:"highlight"}}),this.focus()},dt.setTextAlignment=function(e){return this.forEachBlock(function(t){t.className=(t.className.split(/\s+/).filter(function(e){return!/align/.test(e)}).join(" ")+" align-"+e).trim(),t.style.textAlign=e},!0),this.focus()},dt.setTextDirection=function(e){return this.forEachBlock(function(t){t.dir=e},!0),this.focus()},dt.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Ke(e,t),n=t),n.nodeType===re)return this;this.saveUndoState(e),Pe(e,n);for(var o,r,i,a=n.ownerDocument,l=e.startContainer,d=e.startOffset,c=e.endContainer,f=e.endOffset,u=a.createDocumentFragment(),h=a.createDocumentFragment(),p=H(c,f,n,t),g=H(l,d,n,t);g!==p;)o=g.nextSibling,u.appendChild(g),g=o;return ee(this,u,h),h.normalize(),g=h.firstChild,o=h.lastChild,i=n.childNodes,g?(n.insertBefore(h,p),d=Te.call(i,g),f=Te.call(i,o)+1):(d=Te.call(i,p),f=d),r={startContainer:n,startOffset:d,endContainer:n,endOffset:f},K(n,r),e.setStart(r.startContainer,r.startOffset),e.setEnd(r.endContainer,r.endOffset),Ie(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},dt.increaseQuoteLevel=Et("modifyBlocks",mt);Et("modifyBlocks",vt);dt.makeUnorderedList=Et("modifyBlocks",_t),dt.makeOrderedList=Et("modifyBlocks",Nt),dt.removeList=Et("modifyBlocks",St),dt.increaseListLevel=Et("modifyBlocks",bt),dt.decreaseListLevel=Et("modifyBlocks",Tt);var Bt=function(e,t){return Object.keys(e).reduce(function(n,o){return e[o].forEach(function(e){-1!==t.indexOf(e)&&(n[e]=o)}),n},{})},xt=function(e,n){var o=e.blockquote!=t?"BLOCKQUOTE."+e.blockquote.class:"BLOCKQUOTE",r="BLOCKQUOTE."+e.aside.class,i=e.ul!=t?"UL."+e.ul.class:"UL",a="UL."+e.noLabels.class,s="IMG."+e.pageBreak.class,l={B:"strong",I:"em",H1:"heading",H2:"heading",H3:"heading",H4:"heading",OL:"list",A:"link","MYWO-CONTENT-WIDGET":"smwWidget",BR:"br"};l[o]="blockquote",l[r]="aside",l[i]="list",l[a]="list",l[s]="hr";for(var d in l)-1===n.indexOf(l[d])&&delete l[d];return l},Ot=function(e){var t="H"+e;return function(e){return Ut(this,e,t)}},At=function(e){return Ct(this,e,"UL","noLabels"),e},Lt=function(e){var t=e.querySelector("blockquote.aside");if(t){var n=Rt(this,Array.prototype.slice.call(t.childNodes),"BLOCKQUOTE","blockquote");return t.appendChild(n),e}return Rt(this,e,"BLOCKQUOTE","blockquote")},wt=function(e){return Rt(this,e,"BLOCKQUOTE","aside")},Rt=function(e,n,o,r){var r=r!=t?r:o,i=e._config.tagAttributes[r];return n.constructor===Array?e.createElement(o,i,n):null===n.querySelector(o+"."+i.class)?e.createElement(o,i,[n]):n},Ut=function(e,t,n){var o,r,i,a=e._config.tagAttributes,s=a[n];if((r=t.querySelectorAll("h1, h2, h3, h4"))&&0!==r.length){for(var l=0;l<r.length;l++){o=r[l];O(o,e.createElement(n,s,o.childNodes))}return t}return i=[t],o=e.createElement(n,s,i)},Dt=function(e){for(var t=e.querySelectorAll("h1, h2, h3, h4"),n=0;n<t.length;n++){var o=t[n];O(o,A(o))}return e},It=function(e){var t=e.querySelectorAll("blockquote"),n=this._config.tagAttributes.blockquote;return Wt(t,n.class),e},Pt=function(e){var t=e.querySelectorAll("blockquote"),n=this._config.tagAttributes.aside;return Wt(t,n.class),e},Wt=function(e,t){Array.prototype.filter.call(e,function(e){return e.className===t}).forEach(function(e){O(e,A(e))})};dt.removeBlockquotes=function(){var e=this.getSelection();return this.modifyBlocks(It,e,"BLOCKQUOTE"),this.focus()},dt.removeAsides=function(){var e=this.getSelection();return this.modifyBlocks(Pt,e,"BLOCKQUOTE",{class:"aside"},!0),this.focus()},dt.insertSoftBreak=function(){var e=this,t=e.getSelection();if(!Ft(e,t))return void e.focus();var n=e.createElement("BR");return e._recordUndoState(t),e._getRangeAndRemoveBookmark(t),Ue(t,n,e._root),Se||e._docWasChanged(),t.collapse(!1),e.setSelection(t),e._updatePath(t,!0),e.focus()};var Ft=function(e,t){var n=!0;if(t.collapsed){var o,r,i=t.startContainer;T(i,e._root,p)?n=!1:i.nodeType===re?(o=i.previousSibling,r=i.nextSibling,(i.data.slice(0,t.startOffset).trim()||o&&"BR"!==o.nodeName)&&(i.data.slice(t.endOffset).trim()||!r||r.parentNode.lastChild===r||"BR"!==r.nodeName)||(n=!1)):(i=i.childNodes[t.startOffset])&&(o=i.previousSibling,r=i.nextSibling,"BR"===i.nodeName&&(!o||"BR"===o.nodeName||r&&r.parentNode.lastChild!==r&&"BR"===r.nodeName)&&(n=!1))}else n=!1;return n};dt.insertPageBreak=function(){var e=this,t=e.getSelection(),n=this._config.tagAttributes,o=n.pageBreak,r=this.createElement("IMG",o),i=e.createDefaultBlock([r]);if(i.setAttribute("class",o.class+"-container"),e._recordUndoState(t),e._getRangeAndRemoveBookmark(t),t.collapsed){var a=b(t.endContainer,e._root,"P");a.parentNode.insertBefore(e.createDefaultBlock([]),i.nextSibling),a.parentNode.insertBefore(i,a.nextSibling),a.parentNode.insertBefore(e.createDefaultBlock([]),i.nextSibling)}else{var s=t.startContainer.parentNode;s.parentNode.insertBefore(i,s)}return i.setAttribute("contenteditable","false"),t.setStart(i.nextSibling,0),e.focus(),e.setSelection(t),e._updatePath(t),Se||this._docWasChanged(),e},dt.bold=function(){return Ht(this,{tag:"B"},{tag:"B"})},dt.italic=function(){return Ht(this,{tag:"I"},{tag:"I"})},dt.removeBold=function(){return Ht(this,null,{tag:"B"})},dt.removeItalic=function(){return Ht(this,null,{tag:"I"})};var Mt=function(e,t){e._removeZWS();var n=e.getSelection();return e.hasFormat(t,null,n)?Ht(e,null,{tag:t},n):Ht(e,{tag:t},null,n)},qt=function(e,n,o,r,i){var a=e.getSelection(),s=o!=t?o:null;return e.hasFormat(n,s,a)?i():r()},Ht=function(e,t,n,o){o||(o=e.getSelection());var r=o.startContainer,i=(o.endContainer,o.startOffset),a=o.endOffset;r.nodeType;return o.collapsed&&i<r.textContent.length&&a<r.textContent.length&&r.nodeType===re?(Oe(o),e.changeFormat(t,n,o)):e.changeFormat(t,n,o),e.focus()},Kt=function(e,t){return-1!==e._config.inlineMarkedTypes.indexOf(t)};dt.widgetRangeSelectNextParagraph=function(e){var t;if(t=T(e.startContainer,this._root,m)){for(var n=t.nextSibling;n&&!h(n);)n=_(n,this._root);var o=this._createRange(n,0);Ie(o),o.collapse(!0),this.setSelection(o)}return this.focus()},dt.isAllowedIn=function(e,t,n){var o=[],r=e._classifications.inlineWithText.concat(e._classifications.inlineWithAtomic);switch(e._allowedContent[n]){case"containers":o=r.concat(e._allowedBlocks[n]);break;case"blockAtomic":o=[];break;case"blockWithText":o=r;break;case"inlineWithAtomic":o=[];break;case"inlineWithText":o=e._classifications.inlineWithText;break;default:o=[]}return"heading"===n&&(o=o.filter(function(e){return"br"!=e})),-1!==o.indexOf(t)};var Qt=function(e,t){return e._translateToSmw[t]};dt.h1=Et("modifyBlocks",Ot(1)),dt.h2=Et("modifyBlocks",Ot(2)),dt.h3=Et("modifyBlocks",Ot(3)),dt.h4=Et("modifyBlocks",Ot(4)),dt.removeHeader=Et("modifyBlocks",Dt),dt.makeUnlabeledList=Et("modifyBlocks",At),dt.createBlockQuote=Et("modifyBlocks",Lt),dt.createAside=function(){var e,t=this.getSelection(),n=t.cloneRange(),o=!1;e=T(n.startContainer,this._root,f),e&&(n.setStartBefore(e),o=!0),e=T(n.endContainer,this._root,f),e&&(n.setEndAfter(e),o=!0),this.modifyBlocks(wt,n,null,null,!0,o&&t),this.focus()},dt.addDefaultBlock=function(){this._ensureBottomLine()},dt.mergeInlines=function(){var e=this._root,t=this._doc.createRange();t.selectNode(e),Q(e,t)},dt.fixContainers=function(){return F(this._root,this._root),this},dt.toggleStrong=function(){return Mt(this,"B"),this.focus()},dt.toggleEm=function(){return Mt(this,"I"),this.focus()},dt.toggleHr=function(){return this.insertPageBreak(),this.focus()},dt.toggleBlockquote=function(){var e=this,t=e._config.tagAttributes.blockquote;return qt(e,"BLOCKQUOTE",t,function(){return e.createBlockQuote()},function(){return e.removeBlockquotes()}),this.focus()},dt.toggleAside=function(){var e=this,t=e._config.tagAttributes.aside;return qt(e,"BLOCKQUOTE",t,function(){return e.createAside()},function(){return e.removeAsides()}),this.focus()},dt.setHeading=function(e){return 0===e?this.modifyBlocks(Dt):this.modifyBlocks(Ot(e))},dt.setLink=function(e,t){var n=this.getSelection();this.saveUndoState(n);var o=ne(this._root,"A",null,n);if(o.length>0)o[0].setAttribute("href",e),t&&o[0].setAttribute("title",t);else{n.collapsed&&Oe(n);var r;r=t?{href:e,title:t}:{href:e};var i=n.extractContents(),a=this.createElement("A",r,Array.prototype.slice.call(i.childNodes));Ae(n,a)}return Se||this._docWasChanged(),this.focus()},dt.canUndo=function(){return this._canUndo},dt.canRedo=function(){return this._canRedo},dt.setListFormatting=function(e){var t=this.getSelection(),n=t.collapsed;e?"ordered"===e?this.modifyBlocks(Nt,t,"[OU]L"):"bulleted"===e?this.modifyBlocks(_t,t,"[OU]L"):"noLabels"===e&&this.modifyBlocks(At,t,"[OU]L"):this.modifyBlocks(St,t,"[OU]L");var o=this.getSelection();if(n&&!o.collapsed){var r=We(o,this._root);if(r){var i=this._doc.createRange();i.setStart(r,0),i.collapse(!0),this.setSelection(i),console.log("Fixing selection",i)}}return this.focus()},dt.setWidget=function(e){return this.insertHTML(e),this};var Gt=function(e,t){switch(t){case"UL."+e._config.tagAttributes.noLabels.class:return"noLabels";case"UL."+e._config.tagAttributes.ul.class:return"bulleted";case"OL":return"ordered"}};dt.getFormattingInfoFromCurrentSelection=function(){var e=this,n=e._validTags,o=e.getSelection(),r=o.commonAncestorContainer,i=S(r,"BODY"),a=S(r,"BLOCKQUOTE",e._config.tagAttributes.aside),s={},l={},d=n.map(function(n){var r=Qt(e,n),i=n.split("."),a=i[0],s=i[1],d=s===t?e._config.tagAttributes[a]:{class:s},c=ne(e._root,a,d,o);return c.length>0&&(l[r]?l[r]=l[r].concat(c):l[r]=c),{squireTag:n,smwTag:Qt(e,n),elements:c}}),c=Object.keys(l).filter(function(t){return!Kt(e,t)});return d.forEach(function(t){var n=t.smwTag;if(!s[n]||!s[n].enabled&&!s[n].allowed){var r={};switch(n){case"blockquote":case"aside":case"heading":case"list":case"link":case"smwWidget":case"hr":r.enabled=1===t.elements.length&&l[n]&&1===l[n].length;break;default:r.enabled=l[n]&&l[n].length>0}var d=r.enabled||c.every(function(t){return e.isAllowedIn(e,n,t)||e.isAllowedIn(e,t,n)});if(d)switch(n){case"aside":d=1===t.elements.length&&!i||0===t.elements.length;break;case"hr":d=!l.aside&&o.collapsed;break;case"link":if(d=!1,!i&&!a&&t.elements.length<=1)if(r.enabled||!o.collapsed)d=!0;else if(o.collapsed){var f=o.cloneRange();Oe(f),f.collapsed||(d=!0)}break;case"smwWidget":case"br":d=o.collapsed;break;default:d=!i&&!a}if(r.allowed=d,r.enabled)switch(n){case"list":r.listType=Gt(e,t.squireTag);break;case"heading":r.depth=t.squireTag[1];break;case"link":r.href=t.elements[0].getAttribute("href"),r.title=t.elements[0].title}s[n]=r}}),s},delete dt.underline,delete dt.strikethrough,delete dt.subscript,delete dt.superscript,delete dt.removeUnderline,delete dt.removeStrikethrough,delete dt.removeSubscript,delete dt.removeSuperscript,delete dt.increaseListLevel,delete dt.increaseQuoteLevel,"object"==typeof exports?module.exports=$:"function"==typeof define&&define.amd?define(function(){return $}):(de.Squire=$,top!==de&&"true"===e.documentElement.getAttribute("data-squireinit")&&(de.editor=new $(e),de.onEditorLoad&&(de.onEditorLoad(de.editor),de.onEditorLoad=null)))}(document);